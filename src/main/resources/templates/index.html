<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="fantasy">
<head>
    <link rel="icon" type="image/webp" href="/images/logo.webp">
    <link rel="apple-touch-icon" href="/images/logo.webp">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gal Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.x/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body x-data="productApp()" x-init="init()" class="bg-base-100 min-h-screen">

<header class="bg-base-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold text-base-content">📦 إدارة المنتجات</h1>
            <a href="/categories" class="btn btn-ghost btn-sm">
                🏷️ إدارة التصنيفات
            </a>
            <a href="/messages" class="btn btn-ghost btn-sm">
                📧 الرسائل
            </a>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">

    <div x-show="alert.show" x-transition :class="alert.type === 'success' ? 'alert alert-success' : 'alert alert-error'" class="mb-6" role="alert">
        <p x-text="alert.message" class="font-medium"></p>
    </div>

    <div class="card bg-base-100 shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-base-content mb-4">إضافة منتج جديد</h2>
        <form @submit.prevent="addProduct()" enctype="multipart/form-data">
            <div class="form-control space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" x-model="newProduct.nameAr" placeholder="اسم المنتج بالعربية" class="input input-bordered w-full" required>
                    <input type="text" x-model="newProduct.nameEn" placeholder="اسم المنتج بالإنجليزية" class="input input-bordered w-full" dir="ltr">
                    <input type="number" x-model.number="newProduct.price" placeholder="السعر" step="0.01" min="0" class="input input-bordered w-full" required>
                </div>

                <select x-model="newProduct.categoryId" class="select select-bordered w-full" required>
                    <option value="">اختر التصنيف</option>
                    <template x-for="cat in categories" :key="cat._id">
                        <option :value="cat._id" x-text="cat.nameAr"></option>
                    </template>
                </select>

                <textarea x-model="newProduct.descriptionAr" placeholder="وصف المنتج بالعربية" rows="3" class="textarea textarea-bordered w-full resize-none" required></textarea>
                <textarea x-model="newProduct.descriptionEn" placeholder="وصف المنتج بالإنجليزية" rows="3" class="textarea textarea-bordered w-full resize-none" dir="ltr"></textarea>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">صورة المنتج (اختياري)</span>
                    </label>
                    <input type="file" @change="handleFileSelect($event)" accept="image/*" class="file-input file-input-bordered w-full">
                </div>

                <div x-show="imagePreview" class="flex items-center gap-3">
                    <img :src="imagePreview" alt="Preview" class="w-24 h-24 object-cover rounded-lg">
                    <button type="button" @click="clearImage()" class="btn btn-error btn-sm">إزالة</button>
                </div>

                <button type="submit" class="btn btn-primary w-full md:w-auto">➕ إضافة المنتج</button>
            </div>
        </form>
    </div>

    <div class="card bg-base-100 shadow-md p-4 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-base-content">
                📋 المنتجات الموجودة
                <span class="badge badge-primary" x-text="`${pagination.total} منتج`"></span>
            </h2>
            <div class="flex gap-2 items-center">
                <input type="file" id="csvInput" @change="importCSV($event)" accept=".csv" class="hidden">
                <button @click="document.getElementById('csvInput').click()" class="btn btn-secondary btn-sm">
                    📂 استيراد CSV
                </button>
            </div>
        </div>

        <div class="flex gap-2 items-center">
            <input
                    type="text"
                    placeholder="🔍 ابحث باسم المنتج أو الوصف"
                    x-model="searchQuery"
                    @input.debounce.500ms="searchProducts()"
                    class="input input-bordered flex-1"
            >
            <select x-model="pagination.limit" @change="changeLimit()" class="select select-bordered">
                <option value="12">12 منتج</option>
                <option value="24">24 منتج</option>
                <option value="48">48 منتج</option>
                <option value="100">100 منتج</option>
            </select>
        </div>
    </div>

    <div x-show="loading" class="flex justify-center items-center py-20">
        <div class="loading loading-spinner loading-lg text-primary"></div>
    </div>

    <div x-show="!loading && products.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="product in products" :key="product._id">
            <div class="card bg-base-100 shadow-md overflow-hidden">
                <figure x-show="product.imageUrl" class="h-48 bg-base-300">
                    <img :src="product.imageUrl" :alt="product.nameAr" class="w-full h-full object-cover">
                </figure>
                <div x-show="!product.imageUrl" class="h-48 bg-base-300 flex items-center justify-center text-6xl">
                    📦
                </div>
                <div class="card-body">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="card-title" x-text="product.nameAr"></h3>
                        <span class="badge badge-ghost" x-text="categories.find(c => c._id === product.categoryId)?.nameAr || 'غير محدد'"></span>
                    </div>

                    <p class="text-2xl font-bold text-primary mb-2">
                        <span x-text="product.price.toFixed(2)"></span> جنيه
                    </p>

                    <p class="text-sm text-base-content/70 mb-4 line-clamp-2" x-text="product.descriptionAr"></p>

                    <div class="card-actions flex gap-2">
                        <button @click="openEditModal(product)" class="btn btn-warning btn-sm flex-1">✏️ تعديل</button>
                        <button @click="deleteProduct(product._id)" class="btn btn-error btn-sm flex-1">🗑️ حذف</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <div x-show="!loading && products.length === 0" class="text-center py-20">
        <div class="text-8xl mb-4">📦</div>
        <h3 class="text-2xl font-semibold text-base-content mb-2">لا توجد منتجات</h3>
        <p class="text-base-content/70">ابدأ بإضافة منتج جديد أو جرب البحث</p>
    </div>

    <!-- Pagination Controls -->
    <div x-show="!loading && pagination.totalPages > 1" class="flex justify-center items-center gap-2 mt-8">
        <button @click="goToPage(1)" :disabled="pagination.page === 1" class="btn btn-sm">
            «
        </button>
        <button @click="goToPage(pagination.page - 1)" :disabled="pagination.page === 1" class="btn btn-sm">
            ‹
        </button>

        <template x-for="pageNum in visiblePages" :key="pageNum">
            <button
                    @click="goToPage(pageNum)"
                    :class="pageNum === pagination.page ? 'btn-primary' : 'btn-ghost'"
                    class="btn btn-sm"
                    x-text="pageNum"
            ></button>
        </template>

        <button @click="goToPage(pagination.page + 1)" :disabled="pagination.page === pagination.totalPages" class="btn btn-sm">
            ›
        </button>
        <button @click="goToPage(pagination.totalPages)" :disabled="pagination.page === pagination.totalPages" class="btn btn-sm">
            »
        </button>

        <span class="text-sm text-base-content/70 mr-4">
            صفحة <span x-text="pagination.page"></span> من <span x-text="pagination.totalPages"></span>
        </span>
    </div>

    <!-- Edit Product Modal -->
    <div x-show="modal.show" x-transition @click="modal.show = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div @click.stop x-transition class="card bg-base-100 shadow-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold text-base-content mb-4">تعديل المنتج</h3>
            <div class="form-control space-y-4">
                <input type="text" x-model="modal.product.nameAr" placeholder="اسم المنتج بالعربية" class="input input-bordered w-full" required>
                <input type="text" x-model="modal.product.nameEn" placeholder="اسم المنتج بالإنجليزية" class="input input-bordered w-full" dir="ltr">
                <input type="number" x-model.number="modal.product.price" placeholder="السعر" step="0.01" class="input input-bordered w-full" required>

                <select x-model="modal.product.categoryId" class="select select-bordered w-full" required>
                    <option value="">اختر التصنيف</option>
                    <template x-for="cat in categories" :key="cat._id">
                        <option :value="cat._id" x-text="cat.nameAr"></option>
                    </template>
                </select>

                <textarea x-model="modal.product.descriptionAr" placeholder="وصف المنتج بالعربية" rows="3" class="textarea textarea-bordered w-full resize-none" required></textarea>
                <textarea x-model="modal.product.descriptionEn" placeholder="وصف المنتج بالإنجليزية" rows="3" class="textarea textarea-bordered w-full resize-none" dir="ltr"></textarea>

                <!-- Current Image Display -->
                <div x-show="modal.product.imageUrl && !modal.removeCurrentImageFlag" class="border rounded-lg p-3 bg-base-200">
                    <p class="text-sm font-medium mb-2">الصورة الحالية:</p>
                    <div class="flex items-center gap-3">
                        <img :src="modal.product.imageUrl" alt="Current" class="w-20 h-20 object-cover rounded-lg">
                        <button type="button" @click="removeCurrentImage()" class="btn btn-error btn-sm">🗑️ إزالة الصورة</button>
                    </div>
                </div>

                <!-- New Image Upload -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">تغيير الصورة (اختياري)</span>
                    </label>
                    <input type="file" @change="handleEditFileSelect($event)" accept="image/*" class="file-input file-input-bordered w-full" id="editImageInput">
                </div>

                <!-- New Image Preview -->
                <div x-show="modal.imagePreview" class="border rounded-lg p-3 bg-base-200">
                    <p class="text-sm font-medium mb-2">معاينة الصورة الجديدة:</p>
                    <div class="flex items-center gap-3">
                        <img :src="modal.imagePreview" alt="Preview" class="w-20 h-20 object-cover rounded-lg">
                        <button type="button" @click="clearEditImage()" class="btn btn-error btn-sm">إزالة</button>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" @click="modal.show = false" class="btn btn-ghost flex-1">إلغاء</button>
                    <button type="button" @click="updateProduct()" class="btn btn-primary flex-1">💾 حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

</main>

<script>
    function productApp() {
        return {
            products: [],
            categories: [],
            newProduct: { nameAr: '', nameEn: '', price: 0, descriptionAr: '', descriptionEn: '', categoryId: '' },
            selectedFile: null,
            imagePreview: null,
            modal: {
                show: false,
                product: {},
                selectedFile: null,
                imagePreview: null,
                removeCurrentImageFlag: false
            },
            alert: { show: false, message: '', type: 'success' },
            searchQuery: '',
            loading: false,
            pagination: {
                page: 1,
                limit: 12,
                total: 0,
                totalPages: 0
            },

            get visiblePages() {
                const current = this.pagination.page;
                const total = this.pagination.totalPages;
                const pages = [];

                let start = Math.max(1, current - 2);
                let end = Math.min(total, current + 2);

                if (end - start < 4) {
                    if (start === 1) {
                        end = Math.min(total, start + 4);
                    } else if (end === total) {
                        start = Math.max(1, end - 4);
                    }
                }

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return pages;
            },

            async init() {
                await this.loadCategories();
                await this.loadProducts();
            },

            async loadCategories() {
                try {
                    const res = await fetch('/api/categories', { credentials: 'include' });
                    if (!res.ok) {
                        const text = await res.text();
                        console.log('Load categories response:', text);
                        throw new Error('فشل في جلب التصنيفات');
                    }
                    this.categories = await res.json();
                } catch (err) {
                    console.error('Load categories error:', err);
                    this.showAlert(err.message, 'error');
                }
            },

            async loadProducts() {
                this.loading = true;
                try {
                    const params = new URLSearchParams({
                        page: this.pagination.page,
                        limit: this.pagination.limit,
                        search: this.searchQuery
                    });

                    const res = await fetch(`/api/products?${params}`, { credentials: 'include' });
                    if (!res.ok) {
                        const text = await res.text();
                        console.log('Load products response:', text);
                        throw new Error('فشل في جلب المنتجات');
                    }
                    const data = await res.json();
                    this.products = data.data;
                    this.pagination.total = data.total;
                    this.pagination.totalPages = data.totalPages;
                    this.pagination.page = data.page;
                } catch (err) {
                    console.error('Load products error:', err);
                    this.showAlert(err.message, 'error');
                } finally {
                    this.loading = false;
                }
            },

            async searchProducts() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            async goToPage(page) {
                if (page < 1 || page > this.pagination.totalPages) return;
                this.pagination.page = page;
                await this.loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            async changeLimit() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            handleEditFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.modal.selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.modal.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            clearImage() {
                this.selectedFile = null;
                this.imagePreview = null;
            },

            clearEditImage() {
                this.modal.selectedFile = null;
                this.modal.imagePreview = null;
                document.getElementById('editImageInput').value = '';
            },

            removeCurrentImage() {
                this.modal.removeCurrentImageFlag = true;
                this.modal.product.imageUrl = null;
                this.clearEditImage();
            },

            async addProduct() {
                if (!this.validateProduct(this.newProduct)) return;

                try {
                    let data;
                    if (this.selectedFile) {
                        const formData = new FormData();
                        formData.append('nameAr', this.newProduct.nameAr);
                        formData.append('nameEn', this.newProduct.nameEn);
                        formData.append('price', this.newProduct.price);
                        formData.append('descriptionAr', this.newProduct.descriptionAr);
                        formData.append('descriptionEn', this.newProduct.descriptionEn);
                        formData.append('categoryId', this.newProduct.categoryId);
                        formData.append('image', this.selectedFile);

                        const res = await fetch('/api/products/with-image', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                        });
                        if (!res.ok) {
                            const text = await res.text();
                            console.log('Add product with image response:', text);
                            throw new Error(text || 'فشل في إضافة المنتج');
                        }
                        data = await res.json();
                    } else {
                        const res = await fetch('/api/products', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newProduct),
                            credentials: 'include'
                        });
                        if (!res.ok) {
                            const text = await res.text();
                            console.log('Add product response:', text);
                            throw new Error(text || 'فشل في إضافة المنتج');
                        }
                        data = await res.json();
                    }

                    this.newProduct = { nameAr: '', nameEn: '', price: 0, descriptionAr: '', descriptionEn: '', categoryId: '' };
                    this.clearImage();
                    await this.loadProducts();
                    this.showAlert('✅ تمت الإضافة بنجاح', 'success');
                } catch (err) {
                    console.error('Add product error:', err);
                    this.showAlert(err.message, 'error');
                }
            },

            async importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const res = await fetch('/api/products/import', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });
                    if (!res.ok) {
                        const text = await res.text();
                        console.log('Import CSV response:', text);
                        throw new Error(text || 'فشل في استيراد الملف');
                    }
                    const data = await res.json();
                    await this.loadProducts();
                    this.showAlert(`✅ تم استيراد ${data.data?.length || 0} منتج بنجاح`, 'success');
                } catch (err) {
                    console.error('Import CSV error:', err);
                    this.showAlert(err.message, 'error');
                }
            },

            openEditModal(product) {
                this.modal = {
                    show: true,
                    product: { ...product },
                    selectedFile: null,
                    imagePreview: null,
                    removeCurrentImageFlag: false
                };
            },

            async updateProduct() {
                if (!this.validateProduct(this.modal.product)) return;

                try {
                    let data;
                    if (this.modal.selectedFile || this.modal.removeCurrentImageFlag) {
                        const formData = new FormData();
                        formData.append('nameAr', this.modal.product.nameAr);
                        formData.append('nameEn', this.modal.product.nameEn);
                        formData.append('price', this.modal.product.price);
                        formData.append('descriptionAr', this.modal.product.descriptionAr);
                        formData.append('descriptionEn', this.modal.product.descriptionEn);
                        formData.append('categoryId', this.modal.product.categoryId);
                        if (this.modal.selectedFile) {
                            formData.append('image', this.modal.selectedFile);
                        }
                        if (this.modal.removeCurrentImageFlag) {
                            formData.append('removeImage', 'true');
                        }

                        const res = await fetch(`/api/products/${this.modal.product._id}/with-image`, {
                            method: 'PUT',
                            body: formData,
                            credentials: 'include'
                        });

                        if (!res.ok) {
                            const text = await res.text();
                            console.log('Update product with image response:', text);
                            throw new Error(text || 'فشل في تحديث المنتج');
                        }
                        data = await res.json();
                    } else {
                        const res = await fetch(`/api/products/${this.modal.product._id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.modal.product),
                            credentials: 'include'
                        });
                        if (!res.ok) {
                            const text = await res.text();
                            console.log('Update product response:', text);
                            throw new Error(text || 'فشل في تحديث المنتج');
                        }
                        data = await res.json();
                    }

                    await this.loadProducts();
                    this.modal.show = false;
                    this.showAlert('✅ تم التحديث بنجاح', 'success');
                } catch (err) {
                    console.error('Update product error:', err);
                    this.showAlert(err.message, 'error');
                }
            },

            async deleteProduct(id) {
                if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;

                try {
                    const res = await fetch(`/api/products/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (res.status === 204) {
                        await this.loadProducts();
                        this.showAlert('✅ تم الحذف بنجاح', 'success');
                        return;
                    }
                    if (!res.ok) {
                        const text = await res.text();
                        console.log('Delete product response:', text);
                        throw new Error(text || 'فشل في حذف المنتج');
                    }
                    const data = await res.json();
                    await this.loadProducts();
                    this.showAlert('✅ تم الحذف بنجاح', 'success');
                } catch (err) {
                    console.error('Delete product error:', err);
                    this.showAlert(err.message, 'error');
                }
            },

            validateProduct(product) {
                if (!product.nameAr.trim()) {
                    this.showAlert('⚠️ اسم المنتج بالعربية مطلوب', 'error');
                    return false;
                }
                if (!product.price || product.price <= 0) {
                    this.showAlert('⚠️ السعر يجب أن يكون أكبر من صفر', 'error');
                    return false;
                }
                if (!product.descriptionAr.trim()) {
                    this.showAlert('⚠️ وصف المنتج بالعربية مطلوب', 'error');
                    return false;
                }
                if (!product.categoryId) {
                    this.showAlert('⚠️ يجب اختيار تصنيف', 'error');
                    return false;
                }
                return true;
            },

            showAlert(message, type = 'success') {
                this.alert = { show: true, message, type };
                setTimeout(() => this.alert.show = false, 4000);
            }
        };
    }
</script>

</body>
</html>