<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="luxury">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="pageTitle">كتالوج المنتجات - جال للتجارة</title>
    <link rel="icon" type="image/webp" href="/images/logo.webp">
    <link rel="apple-touch-icon" href="/images/logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.x/dist/full.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/css/productCatalog.css">
    <style>
        body { font-family: "Cairo", sans-serif; }
        .gold-text { color: #d4af37; }
        .cart-badge {
            position: absolute;
            top: -8px;
            inset-inline-end: -8px;
            background: #dc2626;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .dropdown .cart-badge {
            top: 0;
            inset-inline-end: 0;
            transform: translate(50%, -50%);
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .product-image-container,
        .category-image-container {
            background-color: #f5f5f5; /* خلفية موحدة */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 200px; /* ارتفاع مناسب للمنتجات */
        }
        .category-image-container {
            height: 96px; /* ارتفاع مناسب للتصنيفات */
        }
        .product-image,
        .category-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* عرض الصورة بالكامل دون قص */
            object-position: center;
            transition: none; /* إزالة تأثيرات التحويل */
        }
    </style>
</head>
<body class="bg-base-100">

<!-- الهيدر -->
<header class="navbar bg-base-100 shadow-lg sticky top-0 z-50 px-4" x-data="headerManager()">
    <div class="flex-1">
        <a href="/" class="flex items-center gap-3">
            <img src="/images/logo.webp" alt="شعار جال للتجارة" class="navbar-logo" style="width:50px;">
            <span id="brandName" class="text-xl md:text-2xl font-bold">جال لتوريدات المصانع</span>
        </a>
    </div>

    <!-- قائمة Desktop -->
    <nav class="hidden md:flex gap-3">
        <a href="/productCatalog" class="btn btn-ghost btn-sm">
            <i class="fas fa-box-open ml-1"></i> <span id="navProducts">المنتجات</span>
        </a>
        <a href="/cart" class="btn btn-ghost btn-sm relative">
            <i class="fas fa-shopping-cart ml-1"></i>
            <span id="navCart">السلة</span>
            <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
        </a>
        <a href="/contact" class="btn btn-ghost btn-sm">
            <i class="fas fa-phone-alt ml-1"></i> <span id="navContact">تواصل معنا</span>
        </a>
    </nav>

    <!-- Dropdown للموبايل -->
    <div class="dropdown dropdown-end md:hidden relative">
        <button tabindex="0" class="btn btn-ghost btn-lg">
            <i class="fas fa-bars text-2xl"></i>
        </button>
        <ul tabindex="0" class="menu menu-lg dropdown-content mt-3 shadow-2xl bg-base-100 rounded-box w-64 z-[100] p-3 text-lg font-semibold border-2 border-[#d4af37]">
            <li>
                <a href="/productCatalog" class="py-4">
                    <i class="fas fa-box-open ml-2 text-xl"></i> <span id="mnavProducts">المنتجات</span>
                </a>
            </li>
            <li>
                <a href="/cart" class="py-4 relative">
                    <i class="fas fa-shopping-cart ml-2 text-xl"></i>
                    <span id="mnavCart">السلة</span>
                    <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
                </a>
            </li>
            <li>
                <a href="/contact" class="py-4">
                    <i class="fas fa-phone-alt ml-2 text-xl"></i> <span id="mnavContact">تواصل معنا</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- زر اللغة -->
    <div class="dropdown dropdown-end ml-2">
        <label tabindex="0" class="btn btn-ghost">
            🌐 <span id="current-lang">AR</span>
        </label>
        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-28 shadow">
            <li><button onclick="changeLang('ar')">🇸🇦 عربي</button></li>
            <li><button onclick="changeLang('en')">🇬🇧 English</button></li>
        </ul>
    </div>
</header>

<!-- المحتوى الرئيسي -->
<main class="max-w-7xl mx-auto p-6 min-h-[70vh]" x-data="productCatalog()" x-init="init()">

    <!-- العنوان والبحث -->
    <div class="mb-8">
        <h1 id="catalogTitle" class="text-4xl font-bold mb-6 text-center" style="color: #d4af37;">
            <i class="fas fa-box-open ml-2"></i>
            <span id="catalogTitleText">كتالوج المنتجات</span>
            <span class="badge badge-lg ml-2" style="background: rgba(212, 175, 55, 0.2); color: #d4af37;" x-text="`${pagination.total} منتج`"></span>
        </h1>

        <!-- شريط البحث والفلاتر -->
        <div class="glass-card p-6 rounded-2xl mb-6">
            <div class="grid md:grid-cols-3 gap-4">
                <!-- البحث -->
                <div class="form-control md:col-span-2">
                    <div class="input-group">
                        <input id="searchInput" type="text"
                               x-model="searchQuery"
                               @input.debounce.500ms="searchProducts()"
                               placeholder="ابحث عن منتج..."
                               class="input input-bordered w-full bg-base-200 text-gray-200">
                        <button class="btn btn-square" style="background: #d4af37;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- فلتر السعر -->
                <select id="sortSelect" x-model="sortBy"
                        @change="sortProducts()"
                        class="select select-bordered bg-base-200 text-gray-200">
                    <option id="sortDefault" value="">ترتيب حسب</option>
                    <option id="sortPriceAsc" value="price-asc">السعر: من الأقل للأعلى</option>
                    <option id="sortPriceDesc" value="price-desc">السعر: من الأعلى للأقل</option>
                    <option id="sortName" value="name">الاسم</option>
                </select>
            </div>

            <!-- عدد المنتجات في الصفحة -->
            <div class="flex justify-between items-center mt-4">
                <span class="text-gray-400 text-sm">
                    <span id="showingLabel">عرض</span>
                    <span x-text="products.length"></span>
                    <span id="ofLabel">من</span>
                    <span x-text="pagination.total"></span>
                </span>
                <select x-model="pagination.limit" @change="changeLimit()" class="select select-bordered select-sm bg-base-200 text-gray-200">
                    <option value="12">12 منتج</option>
                    <option value="24">24 منتج</option>
                    <option value="48">48 منتج</option>
                    <option value="100">100 منتج</option>
                </select>
            </div>
        </div>

        <!-- شريط التصنيفات الأفقي -->
        <div class="mb-8">
            <h2 id="categoriesTitle" class="text-2xl font-bold mb-4 text-gray-100 flex items-center gap-2">
                <i class="fas fa-layer-group gold-text"></i>
                <span id="categoriesTitleText">التصنيفات</span>
            </h2>

            <div class="relative">
                <!-- أزرار التمرير -->
                <button @click="scrollCategories('right')"
                        class="hidden md:block absolute right-0 top-1/2 -translate-y-1/2 z-10 btn btn-circle btn-sm"
                        style="background: rgba(212, 175, 55, 0.9); border: none;">
                    <i class="fas fa-chevron-right text-slate-900"></i>
                </button>
                <button @click="scrollCategories('left')"
                        class="hidden md:block absolute left-0 top-1/2 -translate-y-1/2 z-10 btn btn-circle btn-sm"
                        style="background: rgba(212, 175, 55, 0.9); border: none;">
                    <i class="fas fa-chevron-left text-slate-900"></i>
                </button>

                <!-- حاوية التصنيفات القابلة للتمرير -->
                <div x-ref="categoriesScroll"
                     class="flex gap-4 overflow-x-auto pb-4 px-2 scroll-smooth hide-scrollbar"
                     style="scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- تصنيف "الكل" -->
                    <div @click="selectedCategory = ''; filterProducts()"
                         :class="selectedCategory === '' ? 'ring-4 ring-[#d4af37]' : ''"
                         class="flex-shrink-0 w-36 glass-card rounded-2xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 group">
                        <div class="h-24 bg-gradient-to-br from-[#d4af37] to-[#ffd700] flex items-center justify-center">
                            <i class="fas fa-th-large text-4xl text-slate-900"></i>
                        </div>
                        <div class="p-3 text-center">
                            <h3 class="font-bold text-gray-100 text-sm" id="allLabel">الكل</h3>
                            <p class="text-xs text-gray-400 mt-1">
                                <span x-text="allProductsCount"></span> <span id="productLabel">منتج</span>
                            </p>
                        </div>
                    </div>

                    <!-- التصنيفات الفعلية -->
                    <template x-for="cat in categories" :key="cat._id">
                        <div @click="selectedCategory = cat._id; filterProducts()"
                             :class="selectedCategory === cat._id ? 'ring-4 ring-[#d4af37]' : ''"
                             class="flex-shrink-0 w-36 glass-card rounded-2xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 group">
                            <div class="category-image-container">
                                <img :src="cat.imageUrl || 'https://via.placeholder.com/150x100?text=' + cat.name"
                                     :alt="cat.name"
                                     class="category-image">
                            </div>
                            <div class="p-3 text-center">
                                <h3 class="font-bold text-gray-100 text-sm line-clamp-1" x-text="cat.name"></h3>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span x-text="getCategoryProductCount(cat._id)"></span> <span id="productLabelCat">منتج</span>
                                </p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- حالة التحميل -->
    <div x-show="loading" class="flex justify-center items-center py-20">
        <div class="loading loading-spinner loading-lg" style="color: #d4af37;"></div>
    </div>

    <!-- رسالة خطأ -->
    <div x-show="error" class="alert alert-error shadow-lg mb-6" x-transition>
        <i class="fas fa-exclamation-circle"></i>
        <span x-text="error"></span>
    </div>

    <!-- عرض المنتجات -->
    <div x-show="!loading && products.length > 0"
         class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
         x-transition>
        <template x-for="product in products" :key="product._id">
            <div class="glass-card rounded-2xl overflow-hidden shadow-xl">
                <!-- صورة المنتج -->
                <div class="relative product-image-container">
                    <img :src="product.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'"
                         :alt="product.name"
                         class="product-image">
                    <div class="absolute top-2 right-2">
                        <span class="badge badge-lg" style="background: #d4af37; color: #1a1a2e; font-weight: bold;">
                            <span x-text="product.price"></span> <span id="currencyLabel">جنيه</span>
                        </span>
                    </div>
                </div>

                <!-- تفاصيل المنتج -->
                <div class="p-5">
                    <h3 class="text-xl font-bold mb-2 text-gray-100" x-text="product.name"></h3>
                    <p class="text-gray-400 text-sm mb-4 line-clamp-2" x-text="product.description"></p>

                    <div class="flex items-center gap-2 mb-4 text-sm text-gray-300">
                        <i class="fas fa-layer-group gold-text"></i>
                        <span x-text="getCategoryName(product.categoryId)"></span>
                    </div>

                    <div class="flex gap-2">
                        <button @click="addToCart(product)"
                                class="btn btn-sm flex-1 text-slate-900 font-bold hover:scale-105 transition-transform"
                                style="background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); border: none;">
                            <i class="fas fa-cart-plus"></i>
                            <span class="ml-2" id="addToCartBtn">أضف للسلة</span>
                        </button>
                        <button @click="showProductDetails(product)"
                                class="btn btn-sm btn-outline"
                                style="border-color: #d4af37; color: #d4af37;">
                            <i class="fas fa-eye"></i> <span class="ml-2" id="viewBtn">عرض</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- رسالة عدم وجود منتجات -->
    <div x-show="!loading && products.length === 0"
         class="text-center py-20"
         x-transition>
        <div class="glass-card rounded-3xl p-12 max-w-md mx-auto">
            <i class="fas fa-box-open text-6xl gold-text mb-4"></i>
            <h3 id="noProductsTitle" class="text-2xl font-bold mb-2 text-gray-100">لا توجد منتجات</h3>
            <p id="noProductsDesc" class="text-gray-400">جرب البحث بكلمات مختلفة أو تصفح جميع التصنيفات</p>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div x-show="!loading && pagination.totalPages > 1" class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8">
        <div class="flex gap-2">
            <button @click="goToPage(1)" :disabled="pagination.page === 1"
                    class="btn btn-sm" style="background: #d4af37; color: #1a1a2e; border: none;">
                «
            </button>
            <button @click="goToPage(pagination.page - 1)" :disabled="pagination.page === 1"
                    class="btn btn-sm" style="background: #d4af37; color: #1a1a2e; border: none;">
                ‹
            </button>

            <template x-for="pageNum in visiblePages" :key="pageNum">
                <button
                        @click="goToPage(pageNum)"
                        :class="pageNum === pagination.page ? 'ring-2 ring-[#d4af37]' : ''"
                        :style="pageNum === pagination.page ? 'background: #d4af37; color: #1a1a2e;' : 'background: rgba(212, 175, 55, 0.2); color: #d4af37;'"
                        class="btn btn-sm"
                        x-text="pageNum"
                ></button>
            </template>

            <button @click="goToPage(pagination.page + 1)" :disabled="pagination.page === pagination.totalPages"
                    class="btn btn-sm" style="background: #d4af37; color: #1a1a2e; border: none;">
                ›
            </button>
            <button @click="goToPage(pagination.totalPages)" :disabled="pagination.page === pagination.totalPages"
                    class="btn btn-sm" style="background: #d4af37; color: #1a1a2e; border: none;">
                »
            </button>
        </div>

        <span class="text-sm text-gray-400">
            <span id="pageLabel">صفحة</span> <span x-text="pagination.page"></span>
            <span id="ofPagesLabel">من</span> <span x-text="pagination.totalPages"></span>
        </span>
    </div>

    <!-- Modal تفاصيل المنتج -->
    <div x-show="showModal"
         x-transition
         @click="showModal = false"
         class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div @click.stop
             x-transition
             class="glass-card rounded-3xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <template x-if="selectedProduct">
                <div>
                    <div class="product-image-container">
                        <img :src="selectedProduct.imageUrl || 'https://via.placeholder.com/600x400'"
                             :alt="selectedProduct.name"
                             class="product-image">
                    </div>
                    <h2 class="text-3xl font-bold mb-4 text-gray-100" x-text="selectedProduct.name"></h2>
                    <p class="text-gray-300 mb-4" x-text="selectedProduct.description"></p>
                    <div class="flex items-center gap-4 mb-6">
                        <span class="text-3xl font-bold gold-text">
                            <span x-text="selectedProduct.price"></span> <span id="currencyLabelModal">جنيه</span>
                        </span>
                        <span class="badge badge-lg" style="background: rgba(212, 175, 55, 0.2); color: #d4af37;">
                            <i class="fas fa-layer-group ml-1"></i>
                            <span x-text="getCategoryName(selectedProduct.categoryId)"></span>
                        </span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="addToCart(selectedProduct); showModal = false"
                                class="btn flex-1 text-slate-900 font-bold"
                                style="background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); border: none;">
                            <i class="fas fa-cart-plus ml-2"></i>
                            <span id="addToCartModalBtn">أضف للسلة</span>
                        </button>
                        <button @click="showModal = false"
                                class="btn btn-outline"
                                style="border-color: #d4af37; color: #d4af37;">
                            <span id="closeBtn">إغلاق</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Toast إضافة للسلة -->
    <div x-show="showToast"
         x-transition
         class="toast toast-top toast-center z-50">
        <div class="alert shadow-2xl" style="background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); color: #1a1a2e; border: none;">
            <i class="fas fa-check-circle text-2xl"></i>
            <span class="font-bold" x-text="toastMessage"></span>
        </div>
    </div>
</main>

<!-- الفوتر -->
<footer class="footer footer-center p-12 glass-card text-gray-300 relative overflow-hidden mt-12" x-data="headerManager()">
    <div class="mb-6 text-center">
        <div class="flex items-center justify-center gap-3 mb-2">
            <img src="/images/logo.webp" alt="شعار" style="width: 50px;">
            <span id="footerBrand" class="text-3xl font-bold gold-text">جال للتجارة</span>
        </div>
        <p id="footerDesc" class="text-gray-400 max-w-md mx-auto">شريكك الموثوق في توريد المعدات والمنتجات الصناعية بأعلى معايير الجودة</p>
    </div>
    <nav class="grid grid-flow-col gap-6 text-base">
        <a href="/productCatalog" class="link link-hover hover:text-[#d4af37]"><i class="fas fa-box-open ml-1"></i> <span id="fnavProducts">المنتجات</span></a>
        <a href="/cart" class="link link-hover hover:text-[#d4af37] relative">
            <i class="fas fa-shopping-cart ml-1"></i> <span id="fnavCart">السلة</span>
            <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
        </a>
        <a href="/contact" class="link link-hover hover:text-[#d4af37]"><i class="fas fa-phone-alt ml-1"></i> <span id="fnavContact">تواصل معنا</span></a>
    </nav>
    <div class="flex justify-center gap-6 text-2xl mt-6 mb-4">
        <a href="#" class="hover:text-blue-600"><i class="fab fa-facebook"></i></a>
        <a href="#" class="hover:text-pink-500"><i class="fab fa-instagram"></i></a>
        <a href="#" class="hover:text-green-500"><i class="fab fa-whatsapp"></i></a>
        <a href="#" class="hover:text-blue-700"><i class="fab fa-linkedin"></i></a>
    </div>
    <p id="copyrightText" class="text-gray-400 mt-4 text-center">© 2025 جال للتجارة والتوريدات — جميع الحقوق محفوظة</p>
</footer>

<script>
    const langs = {
        ar: {
            brandName: "جال لتوريدات المصانع",
            pageTitle: "كتالوج المنتجات - جال للتجارة",
            catalogTitle: "كتالوج المنتجات",
            searchPlaceholder: "ابحث عن منتج...",
            sortDefault: "ترتيب حسب",
            sortPriceAsc: "السعر: من الأقل للأعلى",
            sortPriceDesc: "السعر: من الأعلى للأقل",
            sortName: "الاسم",
            categoriesTitle: "التصنيفات",
            allLabel: "الكل",
            productWord: "منتج",
            addToCartBtn: "أضف للسلة",
            viewBtn: "عرض",
            noProductsTitle: "لا توجد منتجات",
            noProductsDesc: "جرب البحث بكلمات مختلفة أو تصفح جميع التصنيفات",
            currency: "جنيه",
            addToCartToast: 'تمت إضافة "{name}" للسلة',
            showingLabel: "عرض",
            ofLabel: "من",
            pageLabel: "صفحة",
            ofPagesLabel: "من",
            navProducts: "المنتجات",
            navCart: "السلة",
            navContact: "تواصل معنا",
            footerBrand: "جال للتجارة",
            footerDesc: "شريكك الموثوق في توريد المعدات والمنتجات الصناعية بأعلى معايير الجودة",
            copyright: "© 2025 جال للتجارة والتوريدات — جميع الحقوق محفوظة"
        },
        en: {
            brandName: "Gal Industrial Supplies",
            pageTitle: "Product Catalog - Gal Trading",
            catalogTitle: "Product Catalog",
            searchPlaceholder: "Search for a product...",
            sortDefault: "Sort by",
            sortPriceAsc: "Price: low to high",
            sortPriceDesc: "Price: high to low",
            sortName: "Name",
            categoriesTitle: "Categories",
            allLabel: "All",
            productWord: "product",
            addToCartBtn: "Add to cart",
            viewBtn: "View",
            noProductsTitle: "No products found",
            noProductsDesc: "Try different keywords or browse categories",
            currency: "EGP",
            addToCartToast: 'Added "{name}" to cart',
            showingLabel: "Showing",
            ofLabel: "of",
            pageLabel: "Page",
            ofPagesLabel: "of",
            navProducts: "Products",
            navCart: "Cart",
            navContact: "Contact",
            footerBrand: "Gal Trading",
            footerDesc: "Your trusted partner in supplying top-quality industrial products.",
            copyright: "© 2025 Gal Trading & Supplies — All rights reserved"
        }
    };

    function applyTranslations(lang) {
        const t = langs[lang] || langs.ar;
        const map = {
            brandName: t.brandName,
            pageTitle: t.pageTitle,
            catalogTitleText: t.catalogTitle,
            sortDefault: t.sortDefault,
            sortPriceAsc: t.sortPriceAsc,
            sortPriceDesc: t.sortPriceDesc,
            sortName: t.sortName,
            categoriesTitleText: t.categoriesTitle,
            allLabel: t.allLabel,
            productLabel: t.productWord,
            productLabelCat: t.productWord,
            addToCartBtn: t.addToCartBtn,
            addToCartModalBtn: t.addToCartBtn,
            viewBtn: t.viewBtn,
            noProductsTitle: t.noProductsTitle,
            noProductsDesc: t.noProductsDesc,
            currencyLabel: t.currency,
            currencyLabelModal: t.currency,
            showingLabel: t.showingLabel,
            ofLabel: t.ofLabel,
            pageLabel: t.pageLabel,
            ofPagesLabel: t.ofPagesLabel,
            navProducts: t.navProducts,
            navCart: t.navCart,
            navContact: t.navContact,
            mnavProducts: t.navProducts,
            mnavCart: t.navCart,
            mnavContact: t.navContact,
            fnavProducts: t.navProducts,
            fnavCart: t.navCart,
            fnavContact: t.navContact,
            footerBrand: t.footerBrand,
            footerDesc: t.footerDesc,
            copyrightText: t.copyright
        };

        for (const id in map) {
            const el = document.getElementById(id);
            if (!el || map[id] === null) continue;
            el.innerText = map[id];
        }

        const searchEl = document.getElementById('searchInput');
        if (searchEl) searchEl.placeholder = t.searchPlaceholder;

        const curr = document.getElementById('current-lang');
        if (curr) curr.innerText = lang.toUpperCase();

        document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        document.documentElement.lang = (lang === 'ar') ? 'ar' : 'en';
        document.title = t.pageTitle;

        localStorage.setItem('lang', lang);
    }

    function loadSavedLang() {
        const saved = localStorage.getItem('lang') || 'ar';
        applyTranslations(saved);
    }

    function changeLang(lang) {
        applyTranslations(lang);
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', loadSavedLang);

    function productCatalog() {
        return {
            products: [],
            categories: [],
            loading: true,
            error: '',
            searchQuery: '',
            selectedCategory: '',
            sortBy: '',
            showModal: false,
            selectedProduct: null,
            showToast: false,
            toastMessage: '',
            allProductsCount: 0,
            pagination: {
                page: 1,
                limit: 24,
                total: 0,
                totalPages: 0
            },

            get visiblePages() {
                const current = this.pagination.page;
                const total = this.pagination.totalPages;
                const pages = [];

                let start = Math.max(1, current - 2);
                let end = Math.min(total, current + 2);

                if (end - start < 4) {
                    if (start === 1) {
                        end = Math.min(total, start + 4);
                    } else if (end === total) {
                        start = Math.max(1, end - 4);
                    }
                }

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return pages;
            },

            async init() {
                const lang = localStorage.getItem('lang') || 'ar';
                if (typeof applyTranslations === 'function') applyTranslations(lang);

                await this.loadCategories();
                await this.loadProducts();
            },

            async loadProducts() {
                try {
                    this.loading = true;
                    this.error = '';

                    const params = new URLSearchParams({
                        page: this.pagination.page,
                        limit: this.pagination.limit,
                        search: this.searchQuery
                    });

                    const response = await fetch(`/api/products?${params}`);
                    if (!response.ok) throw new Error('فشل تحميل المنتجات');

                    const data = await response.json();

                    if (data.data) {
                        this.products = data.data;
                        this.pagination.total = data.total;
                        this.pagination.totalPages = data.totalPages;
                        this.pagination.page = data.page;
                    } else {
                        this.products = data;
                        this.pagination.total = data.length;
                        this.pagination.totalPages = 1;
                    }

                    if (!this.allProductsCount) {
                        this.allProductsCount = this.pagination.total;
                    }

                    this.applyFilters();
                } catch (err) {
                    this.error = (localStorage.getItem('lang') === 'en') ? 'Failed to load products' : 'حدث خطأ في تحميل المنتجات';
                    console.error(err);
                } finally {
                    this.loading = false;
                }
            },

            async loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    if (!response.ok) throw new Error('فشل تحميل التصنيفات');

                    const data = await response.json();
                    this.categories = data;
                } catch (err) {
                    console.error('خطأ في تحميل التصنيفات:', err);
                }
            },

            async searchProducts() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            async filterProducts() {
                this.pagination.page = 1;
                this.applyFilters();
            },

            applyFilters() {
                let result = [...this.products];

                if (this.selectedCategory) {
                    result = result.filter(p => p.categoryId === this.selectedCategory);
                }

                this.products = result;
                this.sortProducts();
            },

            sortProducts() {
                if (!this.sortBy) return;

                const sorted = [...this.products];

                switch(this.sortBy) {
                    case 'price-asc':
                        sorted.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-desc':
                        sorted.sort((a, b) => b.price - a.price);
                        break;
                    case 'name':
                        const lang = localStorage.getItem('lang') || 'ar';
                        sorted.sort((a, b) => {
                            const an = (a.name || '').toString();
                            const bn = (b.name || '').toString();
                            return an.localeCompare(bn, lang);
                        });
                        break;
                }

                this.products = sorted;
            },

            async goToPage(page) {
                if (page < 1 || page > this.pagination.totalPages) return;
                this.pagination.page = page;
                await this.loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            async changeLimit() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            getCategoryName(categoryId) {
                const category = this.categories.find(c => c._id === categoryId);
                return category ? category.name : (localStorage.getItem('lang') === 'en' ? 'Unspecified' : 'غير محدد');
            },

            getCategoryProductCount(categoryId) {
                return this.products.filter(p => p.categoryId === categoryId).length;
            },

            scrollCategories(direction) {
                const container = this.$refs.categoriesScroll;
                const scrollAmount = 300;

                if (!container) return;
                if (direction === 'left') {
                    container.scrollLeft -= scrollAmount;
                } else {
                    container.scrollLeft += scrollAmount;
                }
            },

            showProductDetails(product) {
                this.selectedProduct = product;
                this.showModal = true;
            },

            addToCart(product) {
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existingItem = cart.find(item => item._id === product._id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({...product, quantity: 1});
                }
                localStorage.setItem('cart', JSON.stringify(cart));

                const cartEvent = new Event('cartUpdated');
                window.dispatchEvent(cartEvent);

                const lang = localStorage.getItem('lang') || 'ar';
                const template = langs[lang]?.addToCartToast || 'تمت إضافة "{name}" للسلة';
                this.toastMessage = template.replace('{name}', product.name);
                this.showToast = true;
                setTimeout(() => { this.showToast = false; }, 3000);
            }
        };
    }

    function headerManager() {
        return {
            cartCount: 0,
            init() {
                this.loadCartCount();
                window.addEventListener('storage', () => this.loadCartCount());
                window.addEventListener('cartUpdated', () => this.loadCartCount());
            },
            loadCartCount() {
                const cart = localStorage.getItem('cart');
                const items = cart ? JSON.parse(cart) : [];
                this.cartCount = items.reduce((sum, item) => sum + item.quantity, 0);
            }
        };
    }
</script>

</body>
</html>