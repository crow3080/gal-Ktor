<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="luxury">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="pageTitle">ูุชุงููุฌ ุงูููุชุฌุงุช - ุฌุงู ููุชุฌุงุฑุฉ</title>
    <link rel="icon" type="image/webp" href="/images/logo.webp">
    <link rel="apple-touch-icon" href="/images/logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.x/dist/full.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/css/productCatalog.css">
    <style>
        body { font-family: "Cairo", sans-serif; }
        .gold-text { color: #d4af37; }
        .cart-badge {
            position: absolute;
            top: -8px;
            inset-inline-end: -8px; /* ูุฏุนู RTL/LTR */
            background: #dc2626;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            transition: all 0.3s ease; /* ุชุฃุซูุฑ ุงูุชูุงู ุณูุณ */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* ุชุญุณูู ุชูุงูู ุงูู badge ูู ูุงุฆูุฉ ุงูููุจุงูู */
        .dropdown .cart-badge {
            top: 0;
            inset-inline-end: 0;
            transform: translate(50%, -50%);
        }
    </style>
</head>
<body class="bg-base-100">

<!-- ุงูููุฏุฑ -->
<header class="navbar bg-base-100 shadow-lg sticky top-0 z-50 px-4" x-data="headerManager()">
    <div class="flex-1">
        <a href="/" class="flex items-center gap-3">
            <img src="/images/logo.webp" alt="ุดุนุงุฑ ุฌุงู ููุชุฌุงุฑุฉ" class="navbar-logo" style="width:50px;">
            <span id="brandName" class="text-xl md:text-2xl font-bold">ุฌุงู ูุชูุฑูุฏุงุช ุงููุตุงูุน</span>
        </a>
    </div>

    <!-- ูุงุฆูุฉ Desktop -->
    <nav class="hidden md:flex gap-3">
        <a href="/productCatalog" class="btn btn-ghost btn-sm">
            <i class="fas fa-box-open ml-1"></i> <span id="navProducts">ุงูููุชุฌุงุช</span>
        </a>
        <a href="/cart" class="btn btn-ghost btn-sm relative">
            <i class="fas fa-shopping-cart ml-1"></i>
            <span id="navCart">ุงูุณูุฉ</span>
            <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
        </a>
        <a href="/contact" class="btn btn-ghost btn-sm">
            <i class="fas fa-phone-alt ml-1"></i> <span id="navContact">ุชูุงุตู ูุนูุง</span>
        </a>
    </nav>

    <!-- Dropdown ููููุจุงูู -->
    <div class="dropdown dropdown-end md:hidden relative">
        <button tabindex="0" class="btn btn-ghost btn-lg">
            <i class="fas fa-bars text-2xl"></i>
        </button>
        <ul tabindex="0" class="menu menu-lg dropdown-content mt-3 shadow-2xl bg-base-100 rounded-box w-64 z-[100] p-3 text-lg font-semibold border-2 border-[#d4af37]">
            <li>
                <a href="/productCatalog" class="py-4">
                    <i class="fas fa-box-open ml-2 text-xl"></i> <span id="mnavProducts">ุงูููุชุฌุงุช</span>
                </a>
            </li>
            <li>
                <a href="/cart" class="py-4 relative">
                    <i class="fas fa-shopping-cart ml-2 text-xl"></i>
                    <span id="mnavCart">ุงูุณูุฉ</span>
                    <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
                </a>
            </li>
            <li>
                <a href="/contact" class="py-4">
                    <i class="fas fa-phone-alt ml-2 text-xl"></i> <span id="mnavContact">ุชูุงุตู ูุนูุง</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- ุฒุฑ ุงููุบุฉ -->
    <div class="dropdown dropdown-end ml-2">
        <label tabindex="0" class="btn btn-ghost">
            ๐ <span id="current-lang">AR</span>
        </label>
        <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box w-28 shadow">
            <li><button onclick="changeLang('ar')">๐ธ๐ฆ ุนุฑุจู</button></li>
            <li><button onclick="changeLang('en')">๐ฌ๐ง English</button></li>
        </ul>
    </div>
</header>

<!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
<main class="max-w-7xl mx-auto p-6 min-h-[70vh]" x-data="productCatalog()" x-init="init()">

    <!-- ุงูุนููุงู ูุงูุจุญุซ -->
    <div class="mb-8">
        <h1 id="catalogTitle" class="text-4xl font-bold mb-6 text-center" style="color: #d4af37;">
            <i class="fas fa-box-open ml-2"></i> <span id="catalogTitleText">ูุชุงููุฌ ุงูููุชุฌุงุช</span>
        </h1>

        <!-- ุดุฑูุท ุงูุจุญุซ ูุงูููุงุชุฑ -->
        <div class="glass-card p-6 rounded-2xl mb-6">
            <div class="grid md:grid-cols-2 gap-4">
                <!-- ุงูุจุญุซ -->
                <div class="form-control">
                    <div class="input-group">
                        <input id="searchInput" type="text"
                               x-model="searchQuery"
                               @input="filterProducts()"
                               placeholder="ุงุจุญุซ ุนู ููุชุฌ..."
                               class="input input-bordered w-full bg-base-200 text-gray-200">
                        <button class="btn btn-square" style="background: #d4af37;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- ููุชุฑ ุงูุณุนุฑ -->
                <select id="sortSelect" x-model="sortBy"
                        @change="sortProducts()"
                        class="select select-bordered bg-base-200 text-gray-200">
                    <option id="sortDefault" value="">ุชุฑุชูุจ ุญุณุจ</option>
                    <option id="sortPriceAsc" value="price-asc">ุงูุณุนุฑ: ูู ุงูุฃูู ููุฃุนูู</option>
                    <option id="sortPriceDesc" value="price-desc">ุงูุณุนุฑ: ูู ุงูุฃุนูู ููุฃูู</option>
                    <option id="sortName" value="name">ุงูุงุณู</option>
                </select>
            </div>
        </div>

        <!-- ุดุฑูุท ุงูุชุตูููุงุช ุงูุฃููู -->
        <div class="mb-8">
            <h2 id="categoriesTitle" class="text-2xl font-bold mb-4 text-gray-100 flex items-center gap-2">
                <i class="fas fa-layer-group gold-text"></i>
                <span id="categoriesTitleText">ุงูุชุตูููุงุช</span>
            </h2>

            <div class="relative">
                <!-- ุฃุฒุฑุงุฑ ุงูุชูุฑูุฑ -->
                <button @click="scrollCategories('right')"
                        class="hidden md:block absolute right-0 top-1/2 -translate-y-1/2 z-10 btn btn-circle btn-sm"
                        style="background: rgba(212, 175, 55, 0.9); border: none;">
                    <i class="fas fa-chevron-right text-slate-900"></i>
                </button>
                <button @click="scrollCategories('left')"
                        class="hidden md:block absolute left-0 top-1/2 -translate-y-1/2 z-10 btn btn-circle btn-sm"
                        style="background: rgba(212, 175, 55, 0.9); border: none;">
                    <i class="fas fa-chevron-left text-slate-900"></i>
                </button>

                <!-- ุญุงููุฉ ุงูุชุตูููุงุช ุงููุงุจูุฉ ููุชูุฑูุฑ -->
                <div x-ref="categoriesScroll"
                     class="flex gap-4 overflow-x-auto pb-4 px-2 scroll-smooth hide-scrollbar"
                     style="scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- ุชุตููู "ุงููู" -->
                    <div @click="selectedCategory = ''; filterProducts()"
                         :class="selectedCategory === '' ? 'ring-4 ring-[#d4af37]' : ''"
                         class="flex-shrink-0 w-36 glass-card rounded-2xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 group">
                        <div class="h-24 bg-gradient-to-br from-[#d4af37] to-[#ffd700] flex items-center justify-center">
                            <i class="fas fa-th-large text-4xl text-slate-900"></i>
                        </div>
                        <div class="p-3 text-center">
                            <h3 class="font-bold text-gray-100 text-sm" id="allLabel">ุงููู</h3>
                            <p class="text-xs text-gray-400 mt-1">
                                <span x-text="products.length"></span> <span id="productLabel">ููุชุฌ</span>
                            </p>
                        </div>
                    </div>

                    <!-- ุงูุชุตูููุงุช ุงููุนููุฉ -->
                    <template x-for="cat in categories" :key="cat._id">
                        <div @click="selectedCategory = cat._id; filterProducts()"
                             :class="selectedCategory === cat._id ? 'ring-4 ring-[#d4af37]' : ''"
                             class="flex-shrink-0 w-36 glass-card rounded-2xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 group">
                            <div class="h-24 overflow-hidden bg-base-300">
                                <img :src="cat.imageUrl || 'https://via.placeholder.com/150x100?text=' + cat.name"
                                     :alt="cat.name"
                                     class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                            </div>
                            <div class="p-3 text-center">
                                <h3 class="font-bold text-gray-100 text-sm line-clamp-1" x-text="cat.name"></h3>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span x-text="getCategoryProductCount(cat._id)"></span> <span id="productLabelCat">ููุชุฌ</span>
                                </p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- ุญุงูุฉ ุงูุชุญููู -->
    <div x-show="loading" class="flex justify-center items-center py-20">
        <div class="loading-spinner"></div>
    </div>

    <!-- ุฑุณุงูุฉ ุฎุทุฃ -->
    <div x-show="error" class="alert alert-error shadow-lg mb-6" x-transition>
        <i class="fas fa-exclamation-circle"></i>
        <span x-text="error"></span>
    </div>

    <!-- ุนุฑุถ ุงูููุชุฌุงุช -->
    <div x-show="!loading && filteredProducts.length > 0"
         class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
         x-transition>
        <template x-for="product in filteredProducts" :key="product._id">
            <div class="glass-card rounded-2xl overflow-hidden shadow-xl">
                <!-- ุตูุฑุฉ ุงูููุชุฌ -->
                <div class="relative">
                    <img :src="product.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'"
                         :alt="product.name"
                         class="w-full product-image">
                    <div class="absolute top-2 right-2">
                        <span class="badge badge-lg" style="background: #d4af37; color: #1a1a2e; font-weight: bold;">
                            <span x-text="product.price"></span> <span id="currencyLabel">ุฌููู</span>
                        </span>
                    </div>
                </div>

                <!-- ุชูุงุตูู ุงูููุชุฌ -->
                <div class="p-5">
                    <h3 class="text-xl font-bold mb-2 text-gray-100" x-text="product.name"></h3>
                    <p class="text-gray-400 text-sm mb-4 line-clamp-2" x-text="product.description"></p>

                    <div class="flex items-center gap-2 mb-4 text-sm text-gray-300">
                        <i class="fas fa-layer-group gold-text"></i>
                        <span x-text="getCategoryName(product.categoryId)"></span>
                    </div>

                    <div class="flex gap-2">
                        <button @click="addToCart(product)"
                                class="btn btn-sm flex-1 text-slate-900 font-bold hover:scale-105 transition-transform"
                                style="background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); border: none;">
                            <i class="fas fa-cart-plus"></i>
                            <span class="ml-2" id="addToCartBtn">ุฃุถู ููุณูุฉ</span>
                        </button>
                        <button @click="showProductDetails(product)"
                                class="btn btn-sm btn-outline"
                                style="border-color: #d4af37; color: #d4af37;">
                            <i class="fas fa-eye"></i> <span class="ml-2" id="viewBtn">ุนุฑุถ</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ููุชุฌุงุช -->
    <div x-show="!loading && filteredProducts.length === 0"
         class="text-center py-20"
         x-transition>
        <div class="glass-card rounded-3xl p-12 max-w-md mx-auto">
            <i class="fas fa-box-open text-6xl gold-text mb-4"></i>
            <h3 id="noProductsTitle" class="text-2xl font-bold mb-2 text-gray-100">ูุง ุชูุฌุฏ ููุชุฌุงุช</h3>
            <p id="noProductsDesc" class="text-gray-400">ุฌุฑุจ ุงูุจุญุซ ุจูููุงุช ูุฎุชููุฉ ุฃู ุชุตูุญ ุฌููุน ุงูุชุตูููุงุช</p>
        </div>
    </div>

    <!-- Modal ุชูุงุตูู ุงูููุชุฌ -->
    <div x-show="showModal"
         x-transition
         @click="showModal = false"
         class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div @click.stop
             x-transition
             class="glass-card rounded-3xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <template x-if="selectedProduct">
                <div>
                    <img :src="selectedProduct.imageUrl || 'https://via.placeholder.com/600x400'"
                         :alt="selectedProduct.name"
                         class="w-full h-64 object-cover rounded-2xl mb-6">
                    <h2 class="text-3xl font-bold mb-4 text-gray-100" x-text="selectedProduct.name"></h2>
                    <p class="text-gray-300 mb-4" x-text="selectedProduct.description"></p>
                    <div class="flex items-center gap-4 mb-6">
                        <span class="text-3xl font-bold gold-text">
                            <span x-text="selectedProduct.price"></span> <span id="currencyLabelModal">ุฌููู</span>
                        </span>
                        <span class="badge badge-lg" style="background: rgba(212, 175, 55, 0.2); color: #d4af37;">
                            <i class="fas fa-layer-group ml-1"></i>
                            <span x-text="getCategoryName(selectedProduct.categoryId)"></span>
                        </span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="addToCart(selectedProduct); showModal = false"
                                class="btn flex-1 text-slate-900 font-bold"
                                style="background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); border: none;">
                            <i class="fas fa-cart-plus ml-2"></i>
                            <span id="addToCartModalBtn">ุฃุถู ููุณูุฉ</span>
                        </button>
                        <button @click="showModal = false"
                                class="btn btn-outline"
                                style="border-color: #d4af37; color: #d4af37;">
                            <span id="closeBtn">ุฅุบูุงู</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Toast ุฅุถุงูุฉ ููุณูุฉ -->
    <div x-show="showToast"
         x-transition
         class="toast toast-top toast-center z-50">
        <div class="alert shadow-2xl" style="background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); color: #1a1a2e; border: none;">
            <i class="fas fa-check-circle text-2xl"></i>
            <span class="font-bold" x-text="toastMessage"></span>
        </div>
    </div>
</main>

<!-- ุงูููุชุฑ -->
<footer class="footer footer-center p-12 glass-card text-gray-300 relative overflow-hidden mt-12" x-data="headerManager()">
    <div class="mb-6 text-center">
        <div class="flex items-center justify-center gap-3 mb-2">
            <img src="/images/logo.webp" alt="ุดุนุงุฑ" class="footer-logo">
            <span id="footerBrand" class="text-3xl font-bold gold-text">ุฌุงู ููุชุฌุงุฑุฉ</span>
        </div>
        <p id="footerDesc" class="text-gray-400 max-w-md mx-auto">ุดุฑููู ุงูููุซูู ูู ุชูุฑูุฏ ุงููุนุฏุงุช ูุงูููุชุฌุงุช ุงูุตูุงุนูุฉ ุจุฃุนูู ูุนุงููุฑ ุงูุฌูุฏุฉ</p>
    </div>
    <nav class="grid grid-flow-col gap-6 text-base">
        <a href="/productCatalog" class="link link-hover hover:text-[#d4af37]"><i class="fas fa-box-open ml-1"></i> <span id="fnavProducts">ุงูููุชุฌุงุช</span></a>
        <a href="/cart" class="link link-hover hover:text-[#d4af37] relative">
            <i class="fas fa-shopping-cart ml-1"></i> <span id="fnavCart">ุงูุณูุฉ</span>
            <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
        </a>
        <a href="/contact" class="link link-hover hover:text-[#d4af37]"><i class="fas fa-phone-alt ml-1"></i> <span id="fnavContact">ุชูุงุตู ูุนูุง</span></a>
    </nav>
    <div class="flex justify-center gap-6 text-2xl mt-6 mb-4">
        <a href="#" class="hover:text-blue-600"><i class="fab fa-facebook"></i></a>
        <a href="#" class="hover:text-pink-500"><i class="fab fa-instagram"></i></a>
        <a href="#" class="hover:text-green-500"><i class="fab fa-whatsapp"></i></a>
        <a href="#" class="hover:text-blue-700"><i class="fab fa-linkedin"></i></a>
    </div>
    <p id="copyrightText" class="text-gray-400 mt-4 text-center">ยฉ 2025 ุฌุงู ููุชุฌุงุฑุฉ ูุงูุชูุฑูุฏุงุช โ ุฌููุน ุงูุญููู ูุญููุธุฉ</p>
</footer>

<script>
    /* ==========================
       Translations (UI only)
       ========================== */
    const langs = {
        ar: {
            brandName: "ุฌุงู ูุชูุฑูุฏุงุช ุงููุตุงูุน",
            pageTitle: "ูุชุงููุฌ ุงูููุชุฌุงุช - ุฌุงู ููุชุฌุงุฑุฉ",
            catalogTitle: "ูุชุงููุฌ ุงูููุชุฌุงุช",
            searchPlaceholder: "ุงุจุญุซ ุนู ููุชุฌ...",
            sortDefault: "ุชุฑุชูุจ ุญุณุจ",
            sortPriceAsc: "ุงูุณุนุฑ: ูู ุงูุฃูู ููุฃุนูู",
            sortPriceDesc: "ุงูุณุนุฑ: ูู ุงูุฃุนูู ููุฃูู",
            sortName: "ุงูุงุณู",
            categoriesTitle: "ุงูุชุตูููุงุช",
            allLabel: "ุงููู",
            productWord: "ููุชุฌ",
            addToCartBtn: "ุฃุถู ููุณูุฉ",
            viewBtn: "ุนุฑุถ",
            noProductsTitle: "ูุง ุชูุฌุฏ ููุชุฌุงุช",
            noProductsDesc: "ุฌุฑุจ ุงูุจุญุซ ุจูููุงุช ูุฎุชููุฉ ุฃู ุชุตูุญ ุฌููุน ุงูุชุตูููุงุช",
            currency: "ุฌููู",
            addToCartToast: 'ุชูุช ุฅุถุงูุฉ "{name}" ููุณูุฉ',
            navProducts: "ุงูููุชุฌุงุช",
            navCart: "ุงูุณูุฉ",
            navContact: "ุชูุงุตู ูุนูุง",
            navLogin: "ุชุณุฌูู ุงูุฏุฎูู",
            mnavProducts: "ุงูููุชุฌุงุช",
            mnavCart: "ุงูุณูุฉ",
            mnavContact: "ุชูุงุตู ูุนูุง",
            mnavLogin: "ุชุณุฌูู ุงูุฏุฎูู",
            fnavProducts: "ุงูููุชุฌุงุช",
            fnavCart: "ุงูุณูุฉ",
            fnavContact: "ุชูุงุตู ูุนูุง",
            footerBrand: "ุฌุงู ููุชุฌุงุฑุฉ",
            footerDesc: "ุดุฑููู ุงูููุซูู ูู ุชูุฑูุฏ ุงููุนุฏุงุช ูุงูููุชุฌุงุช ุงูุตูุงุนูุฉ ุจุฃุนูู ูุนุงููุฑ ุงูุฌูุฏุฉ",
            copyright: "ยฉ 2025 ุฌุงู ููุชุฌุงุฑุฉ ูุงูุชูุฑูุฏุงุช โ ุฌููุน ุงูุญููู ูุญููุธุฉ"
        },
        en: {
            brandName: "Gal Industrial Supplies",
            pageTitle: "Product Catalog - Gal Trading",
            catalogTitle: "Product Catalog",
            searchPlaceholder: "Search for a product...",
            sortDefault: "Sort by",
            sortPriceAsc: "Price: low to high",
            sortPriceDesc: "Price: high to low",
            sortName: "Name",
            categoriesTitle: "Categories",
            allLabel: "All",
            productWord: "product",
            addToCartBtn: "Add to cart",
            viewBtn: "View",
            noProductsTitle: "No products found",
            noProductsDesc: "Try different keywords or browse categories",
            currency: "EGP",
            addToCartToast: 'Added "{name}" to cart',
            navProducts: "Products",
            navCart: "Cart",
            navContact: "Contact",
            navLogin: "Login",
            mnavProducts: "Products",
            mnavCart: "Cart",
            mnavContact: "Contact",
            mnavLogin: "Login",
            fnavProducts: "Products",
            fnavCart: "Cart",
            fnavContact: "Contact",
            footerBrand: "Gal Trading",
            footerDesc: "Your trusted partner in supplying top-quality industrial products.",
            copyright: "ยฉ 2025 Gal Trading & Supplies โ All rights reserved"
        }
    };

    function applyTranslations(lang) {
        const t = langs[lang] || langs.ar;

        // text mapping by element id
        const map = {
            brandName: t.brandName,
            pageTitle: t.pageTitle,
            catalogTitleText: t.catalogTitle,
            searchInput: null, // placeholder handled separately
            sortDefault: t.sortDefault,
            sortPriceAsc: t.sortPriceAsc,
            sortPriceDesc: t.sortPriceDesc,
            sortName: t.sortName,
            categoriesTitleText: t.categoriesTitle,
            allLabel: t.allLabel,
            productLabel: t.productWord,
            productLabelCat: t.productWord,
            addToCartBtn: t.addToCartBtn,
            addToCartModalBtn: t.addToCartBtn,
            viewBtn: t.viewBtn,
            noProductsTitle: t.noProductsTitle,
            noProductsDesc: t.noProductsDesc,
            currencyLabel: t.currency,
            currencyLabelModal: t.currency,
            navProducts: t.navProducts,
            navCart: t.navCart,
            navContact: t.navContact,
            navLogin: t.navLogin,
            mnavProducts: t.navProducts,
            mnavCart: t.navCart,
            mnavContact: t.navContact,
            mnavLogin: t.navLogin,
            fnavProducts: t.navProducts,
            fnavCart: t.navCart,
            fnavContact: t.navContact,
            footerBrand: t.footerBrand,
            footerDesc: t.footerDesc,
            copyrightText: t.copyright
        };

        for (const id in map) {
            const el = document.getElementById(id);
            if (!el || map[id] === null) continue;
            el.innerText = map[id];
        }

        // placeholders
        const searchEl = document.getElementById('searchInput');
        if (searchEl) searchEl.placeholder = t.searchPlaceholder;

        // update current-lang display
        const curr = document.getElementById('current-lang');
        if (curr) curr.innerText = lang.toUpperCase();

        // direction & lang attributes
        document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        document.documentElement.lang = (lang === 'ar') ? 'ar' : 'en';
        document.title = t.pageTitle;

        // save
        localStorage.setItem('lang', lang);
    }

    function loadSavedLang() {
        const saved = localStorage.getItem('lang') || 'ar';
        applyTranslations(saved);
    }

    function changeLang(lang) {
        applyTranslations(lang);
    }

    /* apply on initial load */
    document.addEventListener('DOMContentLoaded', loadSavedLang);

    /* ==========================
       productCatalog Alpine component
       ========================== */
    function productCatalog() {
        return {
            products: [],
            categories: [],
            filteredProducts: [],
            loading: true,
            error: '',
            searchQuery: '',
            selectedCategory: '',
            sortBy: '',
            showModal: false,
            selectedProduct: null,
            showToast: false,
            toastMessage: '',

            async init() {
                // load translations immediate (in case called before DOMContentLoaded)
                const lang = localStorage.getItem('lang') || 'ar';
                if (typeof applyTranslations === 'function') applyTranslations(lang);

                await this.loadCategories();
                await this.loadProducts();
            },

            async loadProducts() {
                try {
                    this.loading = true;
                    this.error = '';

                    const response = await fetch('/api/products');
                    if (!response.ok) throw new Error('ูุดู ุชุญููู ุงูููุชุฌุงุช');

                    const data = await response.json();
                    this.products = data;
                    this.filteredProducts = data;
                } catch (err) {
                    this.error = (localStorage.getItem('lang') === 'en') ? 'Failed to load products' : 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูููุชุฌุงุช';
                    console.error(err);
                } finally {
                    this.loading = false;
                }
            },

            async loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    if (!response.ok) throw new Error('ูุดู ุชุญููู ุงูุชุตูููุงุช');

                    const data = await response.json();
                    this.categories = data;
                } catch (err) {
                    console.error('ุฎุทุฃ ูู ุชุญููู ุงูุชุตูููุงุช:', err);
                }
            },

            filterProducts() {
                let result = [...this.products];

                // ููุชุฑุฉ ุญุณุจ ุงูุจุญุซ
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    result = result.filter(p =>
                        (p.name && p.name.toLowerCase().includes(query)) ||
                        (p.description && p.description.toLowerCase().includes(query))
                    );
                }

                // ููุชุฑุฉ ุญุณุจ ุงูุชุตููู
                if (this.selectedCategory) {
                    result = result.filter(p => p.categoryId === this.selectedCategory);
                }

                this.filteredProducts = result;
                this.sortProducts();
            },

            sortProducts() {
                if (!this.sortBy) return;

                const sorted = [...this.filteredProducts];

                switch(this.sortBy) {
                    case 'price-asc':
                        sorted.sort((a, b) => a.price - b.price);
                        break;
                    case 'price-desc':
                        sorted.sort((a, b) => b.price - a.price);
                        break;
                    case 'name':
                        const lang = localStorage.getItem('lang') || 'ar';
                        sorted.sort((a, b) => {
                            const an = (a.name || '').toString();
                            const bn = (b.name || '').toString();
                            return an.localeCompare(bn, lang);
                        });
                        break;
                }

                this.filteredProducts = sorted;
            },

            getCategoryName(categoryId) {
                const category = this.categories.find(c => c._id === categoryId);
                return category ? category.name : (localStorage.getItem('lang') === 'en' ? 'Unspecified' : 'ุบูุฑ ูุญุฏุฏ');
            },

            getCategoryProductCount(categoryId) {
                return this.products.filter(p => p.categoryId === categoryId).length;
            },

            scrollCategories(direction) {
                const container = this.$refs.categoriesScroll;
                const scrollAmount = 300;

                if (!container) return;
                if (direction === 'left') {
                    container.scrollLeft -= scrollAmount;
                } else {
                    container.scrollLeft += scrollAmount;
                }
            },

            showProductDetails(product) {
                this.selectedProduct = product;
                this.showModal = true;
            },

            addToCart(product) {
                // ุญูุธ ูู localStorage
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existingItem = cart.find(item => item._id === product._id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({...product, quantity: 1});
                }
                localStorage.setItem('cart', JSON.stringify(cart));

                // ุฅุทูุงู ุญุฏุซ ูุฎุตุต ูุชุญุฏูุซ ุงูู badge
                const cartEvent = new Event('cartUpdated');
                window.dispatchEvent(cartEvent);

                // ุฅุธูุงุฑ Toast ุจุงุณุชุฎุฏุงู ุงูุชุฑุฌูุฉ
                const lang = localStorage.getItem('lang') || 'ar';
                const template = langs[lang]?.addToCartToast || 'ุชูุช ุฅุถุงูุฉ "{name}" ููุณูุฉ';
                this.toastMessage = template.replace('{name}', product.name);
                this.showToast = true;
                setTimeout(() => { this.showToast = false; }, 3000);
            }
        };
    }

    function headerManager() {
        return {
            cartCount: 0,
            init() {
                this.loadCartCount();
                // ุงูุงุณุชูุงุน ุฅูู ุญุฏุซ storage ููุชุบููุฑุงุช ุนุจุฑ ุนูุงูุงุช ุงูุชุจููุจ
                window.addEventListener('storage', () => this.loadCartCount());
                // ุงูุงุณุชูุงุน ุฅูู ุงูุญุฏุซ ุงููุฎุตุต ูุชุญุฏูุซุงุช ุงูุณูุฉ ูู ููุณ ุนูุงูุฉ ุงูุชุจููุจ
                window.addEventListener('cartUpdated', () => this.loadCartCount());
            },
            loadCartCount() {
                const cart = localStorage.getItem('cart');
                const items = cart ? JSON.parse(cart) : [];
                this.cartCount = items.reduce((sum, item) => sum + item.quantity, 0);
            }
        };
    }
</script>

</body>
</html>