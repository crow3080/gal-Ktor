<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">طلب عرض سعر - جال للتجارة</title>
    <link rel="icon" type="image/webp" href="/images/logo.webp">
    <link rel="apple-touch-icon" href="/images/logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.x/dist/full.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        :root {
            --primary-color: #0ea5e9;
            --primary-light: #38bdf8;
            --accent-color: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --border-dark: #334155;
        }

        body {
            font-family: "Cairo", sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }

        .primary-color { color: var(--primary-color); }
        .primary-bg { background-color: var(--primary-color); }
        .accent-color { color: var(--accent-color); }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
            border: 1px solid var(--border-dark);
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            inset-inline-end: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .selected-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--primary-color);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
            z-index: 10;
        }

        .product-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .product-card.selected {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }

        .loading-spinner {
            border: 4px solid rgba(14, 165, 233, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .category-btn {
            transition: all 0.2s ease;
            border: 1px solid var(--border-dark);
            background-color: rgba(30, 41, 59, 0.7);
            color: var(--text-secondary);
        }

        .category-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .product-image {
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .pagination-btn {
            border: 1px solid var(--border-dark);
            color: var(--text-secondary);
            background-color: var(--bg-card);
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 6px rgba(14, 165, 233, 0.4);
        }

        .submit-btn:hover {
            box-shadow: 0 6px 10px rgba(14, 165, 233, 0.5);
            transform: translateY(-2px);
        }

        .filter-section {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border-dark);
        }

        .search-box {
            background-color: var(--bg-card);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 12px 16px;
            transition: all 0.2s ease;
        }

        .search-box:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .results-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .view-options {
            display: flex;
            gap: 8px;
        }

        .view-option {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-dark);
            background-color: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .view-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* تحسينات إضافية للثيم الغامق */
        .navbar {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-dark);
        }

        .footer {
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-dark);
        }

        input, select, textarea {
            background-color: var(--bg-card) !important;
            border-color: var(--border-dark) !important;
            color: var(--text-primary) !important;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2) !important;
        }

        .dropdown-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-dark);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-dark);
        }
    </style>
</head>
<body class="bg-slate-900">

<!-- Navbar -->
<header class="navbar sticky top-0 z-50 shadow-lg" x-data="headerManager()">
    <div class="max-w-7xl mx-auto px-4 w-full">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-3">
                <img src="/images/logo.webp" alt="شعار جال للتجارة" class="h-10 w-10">
                <span id="brandName" class="text-xl font-bold primary-color">جال لتوريدات المصانع</span>
            </div>

            <nav class="hidden md:flex gap-2">
                <a href="/productCatalog" class="px-4 py-2 rounded-lg hover:bg-slate-800 text-slate-200 font-medium flex items-center gap-2">
                    <i class="fas fa-box-open"></i> <span id="navProducts">المنتجات</span>
                </a>
                <a href="/cart" class="px-4 py-2 rounded-lg hover:bg-slate-800 text-slate-200 font-medium flex items-center gap-2 relative">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="navCart">السلة</span>
                    <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
                </a>
                <a href="/contact" class="px-4 py-2 rounded-lg hover:bg-slate-800 text-slate-200 font-medium flex items-center gap-2">
                    <i class="fas fa-phone-alt"></i> <span id="navContact">تواصل معنا</span>
                </a>
            </nav>

            <div class="flex items-center gap-2">
                <div class="dropdown dropdown-end md:hidden relative">
                    <button tabindex="0" class="btn btn-ghost">
                        <i class="fas fa-bars text-xl text-slate-200"></i>
                    </button>
                    <ul tabindex="0" class="menu menu-lg dropdown-content mt-3 shadow-2xl bg-slate-800 rounded-box w-64 z-[100] p-3 text-lg font-medium border border-slate-700">
                        <li><a href="/productCatalog" class="py-3 text-slate-200"><i class="fas fa-box-open ml-2"></i> <span id="mnavProducts">المنتجات</span></a></li>
                        <li><a href="/cart" class="py-3 text-slate-200 relative"><i class="fas fa-shopping-cart ml-2"></i><span id="mnavCart">السلة</span><span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span></a></li>
                        <li><a href="/contact" class="py-3 text-slate-200"><i class="fas fa-phone-alt ml-2"></i> <span id="mnavContact">تواصل معنا</span></a></li>
                    </ul>
                </div>

                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost px-3 text-slate-200">
                        <i class="fas fa-globe"></i>
                        <span id="current-lang" class="mr-1">AR</span>
                    </label>
                    <ul tabindex="0" class="dropdown-content menu bg-slate-800 rounded-box w-28 shadow border border-slate-700">
                        <li><button onclick="changeLang('ar')" class="text-slate-200">🇸🇦 عربي</button></li>
                        <li><button onclick="changeLang('en')" class="text-slate-200">🇬🇧 English</button></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 py-8 min-h-screen" x-data="priceRequestApp()" x-init="init()">

    <!-- Header -->
    <div class="text-center mb-12">
        <h1 class="text-3xl md:text-4xl font-bold mb-4 primary-color">
            <i class="fas fa-file-invoice-dollar ml-2"></i>
            <span id="mainTitle">طلب عرض سعر</span>
        </h1>
        <p id="mainDesc" class="text-slate-300 text-lg max-w-2xl mx-auto">اختر المنتجات التي تحتاجها وسنرسل لك عرض سعر مفصل عبر واتساب في أسرع وقت</p>
    </div>

    <!-- Selected Counter -->
    <div x-show="selectedProducts.length > 0" class="card p-6 mb-8 border-r-4 border-r-green-500">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-green-900 p-2 rounded-full">
                    <i class="fas fa-check-circle text-xl text-green-400"></i>
                </div>
                <div>
                    <span class="text-lg font-bold text-slate-100">
                        <span id="selectedLabel">تم اختيار</span>
                        <span x-text="selectedProducts.length" class="primary-color mx-1"></span>
                        <span id="productLabel">منتج</span>
                    </span>
                    <p class="text-sm text-slate-400 mt-1">جاهز لإرسال طلب عرض السعر</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="clearSelection()" class="btn btn-outline btn-sm border-red-800 text-red-400 hover:bg-red-900">
                    <i class="fas fa-times ml-1"></i>
                    <span id="clearBtn">مسح الكل</span>
                </button>
                <button @click="openWhatsAppDialog()" class="btn btn-sm submit-btn">
                    <i class="fas fa-paper-plane ml-2"></i>
                    <span id="submitBtn">إرسال الطلب</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="filter-section">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Search Bar -->
            <div class="lg:col-span-2">
                <div class="search-box">
                    <label class="block text-sm font-medium text-slate-300 mb-2" for="searchInput">
                        <span id="searchLabel">ابحث عن المنتجات</span>
                    </label>
                    <div class="relative">
                        <input type="text"
                               x-model="searchQuery"
                               @input.debounce.300ms="filterProducts()"
                               id="searchInput"
                               placeholder="ابحث باسم المنتج أو الوصف..."
                               class="w-full bg-transparent border-0 focus:outline-none focus:ring-0 text-slate-100">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500"></i>
                    </div>
                </div>
            </div>

            <!-- View Options -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                    عدد المنتجات في الصفحة
                </label>
                <div class="view-options">
                    <button @click="changeLimit(12)" :class="pagination.limit === 12 ? 'active' : ''" class="view-option">
                        12
                    </button>
                    <button @click="changeLimit(24)" :class="pagination.limit === 24 ? 'active' : ''" class="view-option">
                        24
                    </button>
                    <button @click="changeLimit(48)" :class="pagination.limit === 48 ? 'active' : ''" class="view-option">
                        48
                    </button>
                    <button @click="changeLimit(100)" :class="pagination.limit === 100 ? 'active' : ''" class="view-option">
                        100
                    </button>
                </div>
            </div>
        </div>

        <!-- Categories Filter -->
        <div>
            <h2 class="text-lg font-semibold mb-4 text-slate-200 flex items-center gap-2">
                <i class="fas fa-filter primary-color"></i>
                <span id="filterTitle">التصنيفات</span>
            </h2>

            <div class="flex flex-wrap gap-2">
                <button @click="selectedCategory = ''; filterProducts()"
                        :class="selectedCategory === '' ? 'active' : ''"
                        class="category-btn px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-th-large"></i>
                    <span id="allCat">الكل</span>
                    <span class="bg-slate-700 text-slate-300 px-2 py-1 rounded-full text-xs" x-text="pagination.total"></span>
                </button>

                <template x-for="cat in categories" :key="cat._id">
                    <button @click="selectedCategory = cat._id; filterProducts()"
                            :class="selectedCategory === cat._id ? 'active' : ''"
                            class="category-btn px-4 py-2 rounded-lg flex items-center gap-2">
                        <span x-text="lang === 'ar' ? cat.nameAr : cat.nameEn || cat.nameAr"></span>
                        <span class="bg-slate-700 text-slate-300 px-2 py-1 rounded-full text-xs" x-text="getCategoryCount(cat._id)"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- Results Info -->
    <div class="flex justify-between items-center mb-6">
        <div class="results-info">
            <span id="showingLabel">عرض</span>
            <span x-text="filteredProducts.length"></span>
            <span id="ofLabel">من</span>
            <span x-text="pagination.total"></span>
            <span>منتج</span>
        </div>

        <div class="text-sm text-slate-400" x-show="selectedProducts.length > 0">
            <span id="selectedLabel2">محدد:</span>
            <span x-text="selectedProducts.length" class="font-bold primary-color"></span>
        </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-20">
        <div class="loading-spinner"></div>
    </div>

    <!-- Products Grid -->
    <div x-show="!loading && filteredProducts.length > 0"
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
        <template x-for="product in filteredProducts" :key="product._id">
            <div @click="toggleProduct(product)"
                 :class="isSelected(product._id) ? 'selected' : ''"
                 class="product-card card cursor-pointer">

                <!-- Selected Badge -->
                <div x-show="isSelected(product._id)" class="selected-badge">
                    <i class="fas fa-check ml-1"></i>
                    <span id="selectedBadge">محدد</span>
                </div>

                <!-- Product Image -->
                <div class="relative h-48 overflow-hidden bg-slate-800">
                    <img :src="product.imageUrl || 'https://via.placeholder.com/300x200/1e293b/94a3b8?text=No+Image'"
                         :alt="lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr"
                         class="w-full h-full product-image">
                </div>

                <!-- Product Info -->
                <div class="p-4">
                    <h3 class="font-bold mb-2 text-slate-100 line-clamp-2 h-14" x-text="lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr"></h3>
                    <p class="text-slate-400 text-sm mb-3 line-clamp-2 h-10" x-text="lang === 'ar' ? product.descriptionAr : product.descriptionEn || product.descriptionAr"></p>

                    <div class="flex items-center justify-between mt-4">
                        <span class="text-xs text-slate-400 bg-slate-800 px-2 py-1 rounded-full">
                            <i class="fas fa-tag primary-color ml-1"></i>
                            <span x-text="getCategoryName(product.categoryId)"></span>
                        </span>

                        <div x-show="isSelected(product._id)" class="text-green-400">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- No Products -->
    <div x-show="!loading && filteredProducts.length === 0" class="text-center py-16">
        <div class="card rounded-2xl p-12 max-w-md mx-auto border-2 border-dashed border-slate-700">
            <i class="fas fa-box-open text-5xl text-slate-600 mb-4"></i>
            <h3 id="noProductsTitle" class="text-xl font-bold mb-2 text-slate-200">لا توجد منتجات</h3>
            <p id="noProductsDesc" class="text-slate-500">جرب اختيار تصنيف آخر أو تعديل كلمات البحث</p>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div x-show="!loading && pagination.totalPages > 1" class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-12">
        <div class="flex gap-1">
            <button @click="goToPage(1)" :disabled="pagination.page === 1"
                    class="pagination-btn px-3 py-2 rounded-lg">
                <i class="fas fa-angle-double-right"></i>
            </button>
            <button @click="goToPage(pagination.page - 1)" :disabled="pagination.page === 1"
                    class="pagination-btn px-3 py-2 rounded-lg">
                <i class="fas fa-angle-right"></i>
            </button>

            <template x-for="pageNum in visiblePages" :key="pageNum">
                <button
                        @click="goToPage(pageNum)"
                        :class="pageNum === pagination.page ? 'active' : ''"
                        class="pagination-btn px-4 py-2 rounded-lg"
                        x-text="pageNum"
                ></button>
            </template>

            <button @click="goToPage(pagination.page + 1)" :disabled="pagination.page === pagination.totalPages"
                    class="pagination-btn px-3 py-2 rounded-lg">
                <i class="fas fa-angle-left"></i>
            </button>
            <button @click="goToPage(pagination.totalPages)" :disabled="pagination.page === pagination.totalPages"
                    class="pagination-btn px-3 py-2 rounded-lg">
                <i class="fas fa-angle-double-left"></i>
            </button>
        </div>

        <span class="text-sm text-slate-400">
            <span id="pageLabel">صفحة</span> <span x-text="pagination.page"></span>
            <span id="ofPagesLabel">من</span> <span x-text="pagination.totalPages"></span>
        </span>
    </div>

    <!-- Fixed Submit Button -->
    <div x-show="selectedProducts.length > 0"
         class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-40">
        <button @click="openWhatsAppDialog()"
                class="btn btn-lg submit-btn shadow-lg flex items-center gap-2">
            <i class="fas fa-paper-plane"></i>
            <span id="submitBtn2">إرسال الطلب</span>
            <span class="badge bg-slate-800 text-slate-100 font-bold" x-text="selectedProducts.length"></span>
        </button>
    </div>

    <!-- WhatsApp Dialog -->
    <div x-show="showDialog"
         x-transition
         @click="showDialog = false"
         class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div @click.stop
             x-transition
             class="card max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">

            <h2 class="text-2xl font-bold mb-6 text-slate-100 flex items-center gap-3">
                <i class="fab fa-whatsapp text-green-500 text-3xl"></i>
                <span id="dialogTitle">إرسال الطلب عبر واتساب</span>
            </h2>

            <!-- Customer Info Form -->
            <div class="space-y-4 mb-6">
                <div class="form-control">
                    <label class="label">
                        <span id="nameLabel" class="label-text text-slate-300 font-medium">الاسم</span>
                    </label>
                    <input type="text"
                           x-model="customerName"
                           id="nameInput"
                           placeholder="اسمك الكامل"
                           class="input input-bordered w-full text-slate-100 focus:border-primary-color">
                </div>

                <div class="form-control">
                    <label class="label">
                        <span id="phoneLabel" class="label-text text-slate-300 font-medium">رقم الهاتف</span>
                    </label>
                    <div class="flex gap-2">
                        <select x-model="countryCode"
                                class="select select-bordered text-slate-100 focus:border-primary-color"
                                style="max-width: 130px;">
                            <option value="+966">🇸🇦 +966</option>
                            <option value="+971">🇦🇪 +971</option>
                            <option value="+965">🇰🇼 +965</option>
                            <option value="+974">🇶🇦 +974</option>
                            <option value="+973">🇧🇭 +973</option>
                            <option value="+968">🇴🇲 +968</option>
                            <option value="+962">🇯🇴 +962</option>
                            <option value="+961">🇱🇧 +961</option>
                            <option value="+970">🇵🇸 +970</option>
                            <option value="+20">🇪🇬 +20</option>
                            <option value="+212">🇲🇦 +212</option>
                            <option value="+213">🇩🇿 +213</option>
                            <option value="+216">🇹🇳 +216</option>
                            <option value="+218">🇱🇾 +218</option>
                            <option value="+249">🇸🇩 +249</option>
                            <option value="+252">🇸🇴 +252</option>
                            <option value="+269">🇰🇲 +269</option>
                            <option value="+253">🇩🇯 +253</option>
                            <option value="+222">🇲🇷 +222</option>
                            <option value="+86">🇨🇳 +86</option>
                            <option value="+33">🇫🇷 +33</option>
                            <option value="+44">🇬🇧 +44</option>
                            <option value="+1">🇺🇸 +1</option>
                        </select>
                        <input type="tel"
                               x-model="customerPhone"
                               id="phoneInput"
                               placeholder="5xxxxxxxx"
                               class="input input-bordered w-full text-slate-100 focus:border-primary-color">
                    </div>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span id="notesLabel" class="label-text text-slate-300 font-medium">ملاحظات إضافية (اختياري)</span>
                    </label>
                    <textarea x-model="customerNotes"
                              id="notesInput"
                              placeholder="أي تفاصيل إضافية حول طلبك..."
                              class="textarea textarea-bordered w-full text-slate-100 focus:border-primary-color h-24"></textarea>
                </div>
            </div>

            <!-- Selected Products Preview -->
            <div class="mb-6">
                <h3 id="selectedItemsTitle" class="font-bold mb-3 text-slate-200 flex items-center gap-2">
                    <i class="fas fa-list primary-color"></i>
                    المنتجات المحددة (<span x-text="selectedProducts.length"></span>)
                </h3>
                <div class="space-y-2 max-h-60 overflow-y-auto border border-slate-700 rounded-lg p-2">
                    <template x-for="product in selectedProducts" :key="product._id">
                        <div class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg">
                            <img :src="product.imageUrl || 'https://via.placeholder.com/50/1e293b/94a3b8?text=No+Img'"
                                 class="w-12 h-12 object-cover rounded-lg">
                            <div class="flex-1">
                                <p class="font-semibold text-slate-100 text-sm" x-text="lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr"></p>
                                <p class="text-xs text-slate-400" x-text="getCategoryName(product.categoryId)"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button @click="sendToWhatsApp()"
                        :disabled="!customerName || !customerPhone"
                        :class="(!customerName || !customerPhone) ? 'opacity-50 cursor-not-allowed' : ''"
                        class="btn flex-1 text-white font-bold"
                        style="background: #25D366; border: none;">
                    <i class="fab fa-whatsapp ml-2"></i>
                    <span id="sendWhatsAppBtn">إرسال عبر واتساب</span>
                </button>
                <button @click="showDialog = false"
                        class="btn btn-outline border-slate-600 text-slate-300 hover:bg-slate-700">
                    <span id="cancelBtn">إلغاء</span>
                </button>
            </div>
        </div>
    </div>

</main>

<!-- Footer -->
<footer class="border-t border-slate-800 mt-20" x-data="headerManager()">
    <div class="max-w-7xl mx-auto px-4 py-12">
        <div class="text-center mb-8">
            <div class="flex items-center justify-center gap-3 mb-4">
                <img src="/images/logo.webp" alt="شعار" class="h-16 w-16">
                <span id="footerBrand" class="text-2xl font-bold primary-color">جال للتجارة</span>
            </div>
            <p id="footerDesc" class="text-slate-400 max-w-md mx-auto">شريكك الموثوق في توريد المعدات والمنتجات الصناعية والمواد الخام</p>
        </div>
        <nav class="flex flex-wrap justify-center gap-6 mb-8">
            <a href="/productCatalog" class="text-slate-400 hover:text-primary-color transition-colors flex items-center gap-1">
                <i class="fas fa-box-open ml-1"></i> <span id="fnavProducts">المنتجات</span>
            </a>
            <a href="/cart" class="text-slate-400 hover:text-primary-color transition-colors flex items-center gap-1 relative">
                <i class="fas fa-shopping-cart ml-1"></i> <span id="fnavCart">السلة</span>
                <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
            </a>
            <a href="/contact" class="text-slate-400 hover:text-primary-color transition-colors flex items-center gap-1">
                <i class="fas fa-phone-alt ml-1"></i> <span id="fnavContact">تواصل معنا</span>
            </a>
        </nav>
        <p id="copyrightText" class="text-center text-slate-500 text-sm">© 2025 جال للتجارة والتوريدات — جميع الحقوق محفوظة</p>
    </div>
</footer>

<script>
    const langs = {
        ar: {
            brandName: "جال لتوريدات المصانع",
            pageTitle: "طلب عرض سعر - جال للتجارة",
            mainTitle: "طلب عرض سعر",
            mainDesc: "اختر المنتجات التي تحتاجها وسنرسل لك عرض سعر مفصل عبر واتساب في أسرع وقت",
            selectedLabel: "تم اختيار",
            productLabel: "منتج",
            clearBtn: "مسح الكل",
            filterTitle: "التصنيفات",
            allCat: "الكل",
            selectedBadge: "محدد",
            noProductsTitle: "لا توجد منتجات",
            noProductsDesc: "جرب اختيار تصنيف آخر أو تعديل كلمات البحث",
            submitBtn: "إرسال الطلب",
            submitBtn2: "إرسال الطلب",
            dialogTitle: "إرسال الطلب عبر واتساب",
            nameLabel: "الاسم",
            nameInput: "اسمك الكامل",
            phoneLabel: "رقم الهاتف",
            phoneInput: "5xxxxxxxx",
            notesLabel: "ملاحظات إضافية (اختياري)",
            notesInput: "أي تفاصيل إضافية حول طلبك...",
            selectedItemsTitle: "المنتجات المحددة",
            sendWhatsAppBtn: "إرسال عبر واتساب",
            cancelBtn: "إلغاء",
            navProducts: "المنتجات",
            navCart: "السلة",
            navContact: "تواصل معنا",
            mnavProducts: "المنتجات",
            mnavCart: "السلة",
            mnavContact: "تواصل معنا",
            fnavProducts: "المنتجات",
            fnavCart: "السلة",
            fnavContact: "تواصل معنا",
            footerBrand: "جال للتجارة",
            footerDesc: "شريكك الموثوق في توريد المعدات والمنتجات الصناعية والمواد الخام",
            copyrightText: "© 2025 جال للتجارة والتوريدات — جميع الحقوق محفوظة",
            searchLabel: "ابحث عن المنتجات",
            searchInput: "ابحث باسم المنتج أو الوصف...",
            showingLabel: "عرض",
            ofLabel: "من",
            pageLabel: "صفحة",
            ofPagesLabel: "من",
            selectedLabel2: "محدد:"
        },
        en: {
            brandName: "Gal Industrial Supplies",
            pageTitle: "Price Request - Gal Trading",
            mainTitle: "Request a Quote",
            mainDesc: "Select the products you need and we'll send you a detailed quote via WhatsApp as soon as possible",
            selectedLabel: "Selected",
            productLabel: "product(s)",
            clearBtn: "Clear All",
            filterTitle: "Categories",
            allCat: "All",
            selectedBadge: "Selected",
            noProductsTitle: "No Products Found",
            noProductsDesc: "Try selecting another category or modifying your search terms",
            submitBtn: "Submit Request",
            submitBtn2: "Submit Request",
            dialogTitle: "Send Request via WhatsApp",
            nameLabel: "Name",
            nameInput: "Your full name",
            phoneLabel: "Phone Number",
            phoneInput: "5xxxxxxxx",
            notesLabel: "Additional Notes (Optional)",
            notesInput: "Any additional details about your request...",
            selectedItemsTitle: "Selected Products",
            sendWhatsAppBtn: "Send via WhatsApp",
            cancelBtn: "Cancel",
            navProducts: "Products",
            navCart: "Cart",
            navContact: "Contact",
            mnavProducts: "Products",
            mnavCart: "Cart",
            mnavContact: "Contact",
            fnavProducts: "Products",
            fnavCart: "Cart",
            fnavContact: "Contact",
            footerBrand: "Gal Trading",
            footerDesc: "Your trusted partner in industrial equipment, products and raw materials",
            copyrightText: "© 2025 Gal Trading & Supplies — All rights reserved",
            searchLabel: "Search Products",
            searchInput: "Search by product name or description...",
            showingLabel: "Showing",
            ofLabel: "of",
            pageLabel: "Page",
            ofPagesLabel: "of",
            selectedLabel2: "Selected:"
        }
    };

    function applyTranslations(lang) {
        const t = langs[lang] || langs.ar;
        const map = {
            brandName: t.brandName,
            pageTitle: t.pageTitle,
            mainTitle: t.mainTitle,
            mainDesc: t.mainDesc,
            selectedLabel: t.selectedLabel,
            productLabel: t.productLabel,
            clearBtn: t.clearBtn,
            filterTitle: t.filterTitle,
            allCat: t.allCat,
            selectedBadge: t.selectedBadge,
            noProductsTitle: t.noProductsTitle,
            noProductsDesc: t.noProductsDesc,
            submitBtn: t.submitBtn,
            submitBtn2: t.submitBtn2,
            dialogTitle: t.dialogTitle,
            nameLabel: t.nameLabel,
            phoneLabel: t.phoneLabel,
            notesLabel: t.notesLabel,
            selectedItemsTitle: t.selectedItemsTitle,
            sendWhatsAppBtn: t.sendWhatsAppBtn,
            cancelBtn: t.cancelBtn,
            navProducts: t.navProducts,
            navCart: t.navCart,
            navContact: t.navContact,
            mnavProducts: t.mnavProducts,
            mnavCart: t.mnavCart,
            mnavContact: t.mnavContact,
            fnavProducts: t.fnavProducts,
            fnavCart: t.fnavCart,
            fnavContact: t.fnavContact,
            footerBrand: t.footerBrand,
            footerDesc: t.footerDesc,
            copyrightText: t.copyrightText,
            searchLabel: t.searchLabel,
            searchInput: t.searchInput,
            showingLabel: t.showingLabel,
            ofLabel: t.ofLabel,
            pageLabel: t.pageLabel,
            ofPagesLabel: t.ofPagesLabel,
            selectedLabel2: t.selectedLabel2
        };

        for (const id in map) {
            const el = document.getElementById(id);
            if (el && map[id]) el.innerText = map[id];
        }

        // Placeholders
        const nameInput = document.getElementById('nameInput');
        const phoneInput = document.getElementById('phoneInput');
        const notesInput = document.getElementById('notesInput');
        const searchInput = document.getElementById('searchInput');
        if (nameInput) nameInput.placeholder = t.nameInput;
        if (phoneInput) phoneInput.placeholder = t.phoneInput;
        if (notesInput) notesInput.placeholder = t.notesInput;
        if (searchInput) searchInput.placeholder = t.searchInput;

        document.title = t.pageTitle;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
        document.getElementById("current-lang").innerText = lang.toUpperCase();
        localStorage.setItem("lang", lang);
    }

    function changeLang(lang) {
        applyTranslations(lang);
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem("lang") || "ar";
        applyTranslations(saved);
    });

    function headerManager() {
        return {
            cartCount: 0,
            init() {
                this.loadCartCount();
                window.addEventListener('storage', () => this.loadCartCount());
                window.addEventListener('cartUpdated', () => this.loadCartCount());
            },
            loadCartCount() {
                const cart = localStorage.getItem('cart');
                const items = cart ? JSON.parse(cart) : [];
                this.cartCount = items.reduce((sum, item) => sum + item.quantity, 0);
            }
        };
    }

    function priceRequestApp() {
        return {
            products: [],
            categories: [],
            filteredProducts: [],
            selectedProducts: [],
            selectedCategory: '',
            searchQuery: '',
            loading: true,
            error: '',
            showDialog: false,
            customerName: '',
            customerPhone: '',
            countryCode: '+966',
            customerNotes: '',
            lang: localStorage.getItem('lang') || 'ar',
            pagination: {
                page: 1,
                limit: 12,
                total: 0,
                totalPages: 0
            },

            get visiblePages() {
                const current = this.pagination.page;
                const total = this.pagination.totalPages;
                const pages = [];

                let start = Math.max(1, current - 2);
                let end = Math.min(total, current + 2);

                if (end - start < 4) {
                    if (start === 1) {
                        end = Math.min(total, start + 4);
                    } else if (end === total) {
                        start = Math.max(1, end - 4);
                    }
                }

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return pages;
            },

            async init() {
                const lang = localStorage.getItem('lang') || 'ar';
                this.lang = lang;
                if (typeof applyTranslations === 'function') applyTranslations(lang);
                await this.loadCategories();
                await this.loadProducts();
            },

            async loadProducts() {
                try {
                    this.loading = true;
                    this.error = '';
                    const cleanSearchQuery = this.cleanSearchText(this.searchQuery);

                    const params = new URLSearchParams({
                        page: this.pagination.page,
                        limit: this.pagination.limit,
                        search: cleanSearchQuery
                    });

                    if (this.selectedCategory) {
                        params.append('category', this.selectedCategory);
                    }

                    console.log('Search params:', params.toString());

                    const response = await fetch(`/api/products?${params}`);
                    if (!response.ok) throw new Error('Failed to load products');
                    const data = await response.json();

                    if (data.data) {
                        this.products = data.data;
                        this.pagination.total = data.total;
                        this.pagination.totalPages = data.totalPages;
                        this.pagination.page = data.page;
                    } else {
                        this.products = data;
                        this.pagination.total = data.length;
                        this.pagination.totalPages = Math.ceil(data.length / this.pagination.limit);
                    }

                    this.filteredProducts = this.products;
                } catch (err) {
                    this.error = (this.lang === 'en' ? 'Failed to load products' : 'حدث خطأ في تحميل المنتجات');
                    console.error('Error loading products:', err);
                } finally {
                    this.loading = false;
                }
            },

            cleanSearchText(text) {
                if (!text) return '';

                return text
                    .replace(/[^\w\u0600-\u06FF\s\d]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            },

            async loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    if (!response.ok) throw new Error('Failed to load categories');
                    this.categories = await response.json();
                } catch (err) {
                    console.error('Error loading categories:', err);
                }
            },

            async filterProducts() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            toggleProduct(product) {
                const index = this.selectedProducts.findIndex(p => p._id === product._id);
                if (index > -1) {
                    this.selectedProducts.splice(index, 1);
                } else {
                    this.selectedProducts.push(product);
                }
            },

            isSelected(productId) {
                return this.selectedProducts.some(p => p._id === productId);
            },

            clearSelection() {
                this.selectedProducts = [];
            },

            getCategoryName(categoryId) {
                const cat = this.categories.find(c => c._id === categoryId);
                return cat ? (this.lang === 'ar' ? cat.nameAr : cat.nameEn || cat.nameAr) : (this.lang === 'en' ? 'Unspecified' : 'غير محدد');
            },

            getCategoryCount(categoryId) {
                return this.products.filter(p => p.categoryId === categoryId).length;
            },

            async goToPage(page) {
                if (page < 1 || page > this.pagination.totalPages) return;
                this.pagination.page = page;
                await this.loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            async changeLimit(limit) {
                this.pagination.limit = limit;
                this.pagination.page = 1;
                await this.loadProducts();
            },

            openWhatsAppDialog() {
                this.showDialog = true;
            },

            sendToWhatsApp() {
                if (!this.customerName || !this.customerPhone) {
                    const lang = this.lang;
                    alert(lang === 'en' ? 'Please fill in name and phone number' : 'يرجى ملء الاسم ورقم الهاتف');
                    return;
                }

                // Build WhatsApp message
                let message = this.lang === 'en'
                    ? `*Price Request*\n\n*Customer Name:* ${this.customerName}\n*Phone:* ${this.countryCode}${this.customerPhone}\n\n*Selected Products:*\n\n`
                    : `*طلب عرض سعر*\n\n*اسم العميل:* ${this.customerName}\n*الهاتف:* ${this.countryCode}${this.customerPhone}\n\n*المنتجات المطلوبة:*\n\n`;

                this.selectedProducts.forEach((product, index) => {
                    const name = this.lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr;
                    const description = this.lang === 'ar' ? product.descriptionAr : product.descriptionEn || product.descriptionAr;
                    message += `${index + 1}. ${name}\n`;
                    message += `   ${this.lang === 'en' ? 'Category' : 'التصنيف'}: ${this.getCategoryName(product.categoryId)}\n`;
                    if (description) {
                        message += `   ${this.lang === 'en' ? 'Details' : 'الوصف'}: ${description}\n`;
                    }
                    message += `\n`;
                });

                if (this.customerNotes) {
                    message += this.lang === 'en'
                        ? `\n*Additional Notes:*\n${this.customerNotes}`
                        : `\n*ملاحظات إضافية:*\n${this.customerNotes}`;
                }

                // Company WhatsApp number
                const whatsappNumber = '+201002491168';
                const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

                window.open(url, '_blank');

                // Reset form
                this.showDialog = false;
                this.customerName = '';
                this.customerPhone = '';
                this.countryCode = '+966';
                this.customerNotes = '';
                this.selectedProducts = [];
            }
        };
    }
</script>
</body>
</html>