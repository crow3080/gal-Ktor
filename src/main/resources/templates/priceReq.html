<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">طلب عرض سعر - جال للتجارة</title>
    <link rel="icon" type="image/webp" href="/images/logo.webp">
    <link rel="apple-touch-icon" href="/images/logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#d4af37',
                        primaryDark: '#b8941f',
                        secondary: '#374151',
                        dark: '#111827',
                        light: '#1f2937'
                    }
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.x/dist/full.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: "Tajawal", sans-serif; background-color: #111827; }
        .primary-text { color: #d4af37; }
        .primary-bg { background-color: #d4af37; }
        .primary-border { border-color: #d4af37; }
        .product-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
            background-color: #1f2937;
            color: #f9fafb;
        }
        .product-card:hover {
            transform: translateY(-5px);
            border-color: #d4af37;
            box-shadow: 0 10px 25px rgba(212, 175, 55, 0.2);
        }
        .product-card.selected {
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.5);
        }
        .product-image {
            transition: transform 0.3s ease;
        }
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        .cart-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        .selected-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .loading-spinner {
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .glass-card {
            background: rgba(31, 41, 55, 0.85); /* darker bg */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        .pagination-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #374151; /* darker bg */
            color: #f9fafb;
            border: 1px solid #4b5563;
        }
        .pagination-btn:hover {
            background-color: #4b5563;
        }
        .pagination-btn.active {
            background-color: #d4af37;
            color: #111827;
            border-color: #d4af37;
        }
        .btn-outline {
            border-color: #4b5563;
            color: #f9fafb;
        }
        .btn-outline:hover {
            border-color: #d4af37;
            color: #d4af37;
        }
        .input-bordered {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .input-bordered:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.5);
        }
        .select-bordered {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .select-bordered:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.5);
        }
        .textarea-bordered {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .textarea-bordered:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

<!-- Navbar -->
<header class="navbar bg-gray-800 shadow-md sticky top-0 z-50 px-4 border-b border-gray-700">
    <div class="flex-1">
        <a href="/" class="flex items-center gap-3">
            <img src="/images/logo.webp" alt="شعار جال للتجارة" class="w-12 h-12 object-contain">
            <span id="brandName" class="text-xl md:text-2xl font-bold primary-text">جال لتوريدات المصانع</span>
        </a>
    </div>

    <div class="flex items-center gap-2">
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-ghost btn-sm text-gray-200">
                <i class="fas fa-globe text-lg"></i>
                <span id="current-lang">AR</span>
            </label>
            <ul tabindex="0" class="dropdown-content menu bg-gray-800 rounded-box w-32 shadow-lg p-2 border border-gray-700">
                <li><button onclick="changeLang('ar')" class="p-2 hover:bg-gray-700 rounded text-gray-200">🇸🇦 عربي</button></li>
                <li><button onclick="changeLang('en')" class="p-2 hover:bg-gray-700 rounded text-gray-200">🇬🇧 English</button></li>
            </ul>
        </div>

        <div class="dropdown dropdown-end md:hidden">
            <button tabindex="0" class="btn btn-ghost btn-md text-gray-200">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[100] p-2 shadow bg-gray-800 rounded-box w-52 border border-gray-700">
                <li><a href="/productCatalog" class="py-3 text-gray-200"><i class="fas fa-box-open ml-2"></i> <span id="mnavProducts">المنتجات</span></a></li>
                <li><a href="/cart" class="py-3 relative text-gray-200"><i class="fas fa-shopping-cart ml-2"></i><span id="mnavCart">السلة</span><span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span></a></li>
                <li><a href="/contact" class="py-3 text-gray-200"><i class="fas fa-phone-alt ml-2"></i> <span id="mnavContact">تواصل معنا</span></a></li>
            </ul>
        </div>

        <nav class="hidden md:flex items-center gap-2">
            <a href="/productCatalog" class="btn btn-ghost btn-sm text-gray-200">
                <i class="fas fa-box-open ml-1"></i> <span id="navProducts">المنتجات</span>
            </a>
            <a href="/cart" class="btn btn-ghost btn-sm relative text-gray-200">
                <i class="fas fa-shopping-cart ml-1"></i>
                <span id="navCart">السلة</span>
                <span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span>
            </a>
            <a href="/contact" class="btn btn-ghost btn-sm text-gray-200">
                <i class="fas fa-phone-alt ml-1"></i> <span id="navContact">تواصل معنا</span>
            </a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="max-w-7xl mx-auto p-4 md:p-6 min-h-screen">
    <div x-data="priceRequestApp()" x-init="init()">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-3 primary-text">
                <i class="fas fa-file-invoice-dollar ml-2"></i>
                <span id="mainTitle">طلب عرض سعر</span>
            </h1>
            <p id="mainDesc" class="text-gray-300">اختر المنتجات التي تحتاجها وسنرسل لك عرض سعر مفصل</p>
        </div>

        <!-- Selected Counter and Limit Selector -->
        <div x-show="selectedProducts.length > 0" class="bg-gray-800 p-4 rounded-xl mb-6 flex flex-col sm:flex-row items-center justify-between gap-4 shadow-sm border border-gray-700">
            <div class="flex items-center gap-3">
                <i class="fas fa-check-circle text-2xl text-green-500"></i>
                <span class="text-lg font-semibold text-gray-100">
                    <span id="selectedLabel">تم اختيار</span>
                    <span x-text="selectedProducts.length" class="primary-text mx-1"></span>
                    <span id="productLabel">منتج</span>
                </span>
            </div>
            <div class="flex items-center gap-3">
                <label class="text-sm font-medium text-gray-300 mr-2" for="itemsPerPage">عدد العناصر/الصفحة:</label>
                <select id="itemsPerPage" x-model="pagination.limit" @change="changeLimit()" class="select select-bordered select-sm w-24 bg-gray-700 text-gray-100 border-gray-600">
                    <option value="12">12</option>
                    <option value="24">24</option>
                    <option value="48">48</option>
                    <option value="100">100</option>
                </select>
                <button @click="clearSelection()" class="btn btn-sm btn-outline btn-error text-gray-200">
                    <i class="fas fa-trash ml-1"></i>
                    <span id="clearBtn">مسح الكل</span>
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="bg-gray-800 p-4 rounded-xl mb-6 shadow-sm border border-gray-700">
            <div class="form-control">
                <label class="label">
                    <span id="searchLabel" class="label-text text-gray-300 font-medium">بحث عن المنتجات</span>
                </label>
                <div class="relative">
                    <input type="text"
                           x-model="searchQuery"
                           @input.debounce.300ms="filterProducts()"
                           id="searchInput"
                           placeholder="ابحث باسم المنتج أو الوصف..."
                           class="input input-bordered w-full bg-gray-700 text-gray-100 pr-10">
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Categories Filter -->
        <div class="bg-gray-800 p-4 rounded-xl mb-6 shadow-sm border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-gray-100 flex items-center gap-2">
                <i class="fas fa-filter primary-text"></i>
                <span id="filterTitle">تصفية حسب التصنيف</span>
            </h2>

            <div class="flex flex-wrap gap-2">
                <button @click="selectedCategory = ''; filterProducts()"
                        :class="selectedCategory === '' ? 'bg-primary text-gray-900' : 'bg-gray-700 text-gray-200 hover:bg-gray-600'"
                        class="btn btn-sm px-4 py-2 rounded-full flex items-center gap-1">
                    <i class="fas fa-th-large ml-1"></i>
                    <span id="allCat">جميع التصنيفات</span>
                    <span class="badge badge-sm badge-ghost text-gray-300" x-text="pagination.total"></span>
                </button>

                <template x-for="cat in categories" :key="cat._id">
                    <button @click="selectedCategory = cat._id; filterProducts()"
                            :class="selectedCategory === cat._id ? 'bg-primary text-gray-900' : 'bg-gray-700 text-gray-200 hover:bg-gray-600'"
                            class="btn btn-sm px-4 py-2 rounded-full flex items-center gap-1">
                        <span x-text="lang === 'ar' ? cat.nameAr : cat.nameEn || cat.nameAr"></span>
                        <span class="badge badge-sm badge-ghost text-gray-300" x-text="getCategoryCount(cat._id)"></span>
                    </button>
                </template>
            </div>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="flex justify-center py-20">
            <div class="loading-spinner"></div>
        </div>

        <!-- Products Grid -->
        <div x-show="!loading && filteredProducts.length > 0"
             class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
            <template x-for="product in filteredProducts" :key="product._id">
                <div @click="toggleProduct(product)"
                     :class="isSelected(product._id) ? 'selected' : ''"
                     class="product-card rounded-xl shadow-sm border border-gray-700 overflow-hidden flex flex-col h-full">

                    <!-- Selected Badge -->
                    <div x-show="isSelected(product._id)" class="selected-badge">
                        <i class="fas fa-check ml-1"></i>
                        <span id="selectedBadge">محدد</span>
                    </div>

                    <!-- Product Image -->
                    <div class="relative h-40 overflow-hidden bg-gray-700">
                        <img :src="product.imageUrl || 'https://placehold.co/300x200?text=No+Image'"
                             :alt="lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr"
                             class="product-image w-full h-full object-cover">
                    </div>

                    <!-- Product Info -->
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-md font-bold mb-2 text-gray-100 line-clamp-2" x-text="lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr"></h3>
                        <p class="text-gray-400 text-sm mb-3 line-clamp-2 flex-grow" x-text="lang === 'ar' ? product.descriptionAr : product.descriptionEn || product.descriptionAr"></p>

                        <div class="mt-auto pt-2 border-t border-gray-700 flex items-center justify-between">
                            <span class="text-xs text-gray-400 flex items-center gap-1">
                                <i class="fas fa-layer-group primary-text"></i>
                                <span x-text="getCategoryName(product.categoryId)"></span>
                            </span>

                            <div x-show="isSelected(product._id)">
                                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- No Products -->
        <div x-show="!loading && filteredProducts.length === 0" class="text-center py-20">
            <div class="bg-gray-800 rounded-2xl p-12 max-w-md mx-auto shadow-sm border border-gray-700">
                <i class="fas fa-box-open text-6xl primary-text mb-4"></i>
                <h3 id="noProductsTitle" class="text-xl font-bold mb-2 text-gray-100">لا توجد منتجات</h3>
                <p id="noProductsDesc" class="text-gray-400">جرب اختيار تصنيف آخر أو تعديل البحث</p>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div x-show="!loading && pagination.totalPages > 1" class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8">
            <div class="flex flex-wrap justify-center gap-1">
                <button @click="goToPage(1)" :disabled="pagination.page === 1"
                        class="btn btn-sm pagination-btn btn-outline text-gray-200">
                    «
                </button>
                <button @click="goToPage(pagination.page - 1)" :disabled="pagination.page === 1"
                        class="btn btn-sm pagination-btn btn-outline text-gray-200">
                    ‹
                </button>

                <template x-for="pageNum in visiblePages" :key="pageNum">
                    <button
                            @click="goToPage(pageNum)"
                            :class="pageNum === pagination.page ? 'pagination-btn active' : 'pagination-btn'"
                            class="btn btn-sm"
                            x-text="pageNum"
                    ></button>
                </template>

                <button @click="goToPage(pagination.page + 1)" :disabled="pagination.page === pagination.totalPages"
                        class="btn btn-sm pagination-btn btn-outline text-gray-200">
                    ›
                </button>
                <button @click="goToPage(pagination.totalPages)" :disabled="pagination.page === pagination.totalPages"
                        class="btn btn-sm pagination-btn btn-outline text-gray-200">
                    »
                </button>
            </div>

            <div class="text-sm text-gray-400 mt-2 sm:mt-0">
                <span x-text="`${langs[lang]?.showingLabel || 'عرض'} ${(pagination.page - 1) * pagination.limit + 1}-${Math.min(pagination.page * pagination.limit, pagination.total)} ${langs[lang]?.ofLabel || 'من'} ${pagination.total}`"></span>
            </div>
        </div>

        <!-- Submit Button -->
        <div x-show="selectedProducts.length > 0"
             class="fixed bottom-6 right-1/2 transform translate-x-1/2 z-40">
            <button @click="openWhatsAppDialog()"
                    class="btn btn-lg font-bold shadow-lg flex items-center gap-2 px-8 py-4"
                    style="background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%); color: #111827; border: none;">
                <i class="fab fa-whatsapp text-xl"></i>
                <span id="submitBtn">إرسال الطلب</span>
                <span class="badge badge-lg badge-warning text-black" x-text="selectedProducts.length"></span>
            </button>
        </div>

        <!-- WhatsApp Dialog -->
        <div x-show="showDialog"
             x-transition.opacity.duration.300ms
             @click="showDialog = false"
             class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div @click.stop
                 x-transition.scale.duration.300ms
                 class="bg-gray-800 rounded-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto border border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-gray-100 flex items-center gap-2">
                        <i class="fab fa-whatsapp text-green-500 text-2xl"></i>
                        <span id="dialogTitle">إرسال الطلب عبر واتساب</span>
                    </h2>
                    <button @click="showDialog = false" class="btn btn-sm btn-circle btn-ghost text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Customer Info Form -->
                <div class="space-y-4 mb-6">
                    <div class="form-control">
                        <label class="label">
                            <span id="nameLabel" class="label-text text-gray-300">الاسم</span>
                        </label>
                        <input type="text"
                               x-model="customerName"
                               id="nameInput"
                               placeholder="اسمك الكامل"
                               class="input input-bordered w-full bg-gray-700 text-gray-100">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span id="phoneLabel" class="label-text text-gray-300">رقم الهاتف</span>
                        </label>
                        <div class="flex gap-2">
                            <select x-model="countryCode"
                                    class="select select-bordered w-32 bg-gray-700 text-gray-100 border-gray-600">
                                <option value="+966">🇸🇦 +966</option>
                                <option value="+971">🇦🇪 +971</option>
                                <option value="+965">🇰🇼 +965</option>
                                <option value="+974">🇶🇦 +974</option>
                                <option value="+973">🇧🇭 +973</option>
                                <option value="+968">🇴🇲 +968</option>
                                <option value="+962">🇯🇴 +962</option>
                                <option value="+961">🇱🇧 +961</option>
                                <option value="+970">🇵🇸 +970</option>
                                <option value="+20">🇪🇬 +20</option>
                                <option value="+212">🇲🇦 +212</option>
                                <option value="+213">🇩🇿 +213</option>
                                <option value="+216">🇹🇳 +216</option>
                                <option value="+218">🇱🇾 +218</option>
                                <option value="+249">🇸🇩 +249</option>
                                <option value="+252">🇸🇴 +252</option>
                                <option value="+269">🇰🇲 +269</option>
                                <option value="+253">🇩🇯 +253</option>
                                <option value="+222">🇲🇷 +222</option>
                                <option value="+86">🇨🇳 +86</option>
                                <option value="+33">🇫🇷 +33</option>
                                <option value="+44">🇬🇧 +44</option>
                                <option value="+1">🇺🇸 +1</option>
                            </select>
                            <input type="tel"
                                   x-model="customerPhone"
                                   id="phoneInput"
                                   placeholder="01xxxxxxxxx"
                                   class="input input-bordered w-full bg-gray-700 text-gray-100">
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span id="notesLabel" class="label-text text-gray-300">ملاحظات إضافية (اختياري)</span>
                        </label>
                        <textarea x-model="customerNotes"
                                  id="notesInput"
                                  placeholder="أي تفاصيل إضافية..."
                                  class="textarea textarea-bordered w-full h-24 bg-gray-700 text-gray-100"></textarea>
                    </div>
                </div>

                <!-- Selected Products Preview -->
                <div class="mb-6">
                    <h3 id="selectedItemsTitle" class="font-bold mb-3 text-gray-100 flex items-center gap-2">
                        <i class="fas fa-list primary-text"></i>
                        المنتجات المحددة (<span x-text="selectedProducts.length"></span>)
                    </h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <template x-for="product in selectedProducts" :key="product._id">
                            <div class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg">
                                <img :src="product.imageUrl || 'https://placehold.co/50x50?text=Img'"
                                     class="w-12 h-12 object-cover rounded-lg bg-gray-600">
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-100 text-sm truncate" x-text="lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr"></p>
                                    <p class="text-xs text-gray-400 truncate" x-text="getCategoryName(product.categoryId)"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button @click="sendToWhatsApp()"
                            :disabled="!customerName || !customerPhone"
                            :class="(!customerName || !customerPhone) ? 'opacity-60' : ''"
                            class="btn flex-1 text-white font-bold"
                            style="background: #25D366; border: none;">
                        <i class="fab fa-whatsapp ml-2 text-xl"></i>
                        <span id="sendWhatsAppBtn">إرسال عبر واتساب</span>
                    </button>
                    <button @click="showDialog = false"
                            class="btn btn-outline btn-secondary text-gray-200 border-gray-600 hover:bg-gray-700">
                        <span id="cancelBtn">إلغاء</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="footer footer-center p-10 bg-gray-800 text-gray-400 border-t border-gray-700">
    <div class="mb-6 text-center">
        <div class="flex items-center justify-center gap-3 mb-2">
            <img src="/images/logo.webp" alt="شعار" class="w-16 h-16 object-contain">
            <span id="footerBrand" class="text-2xl font-bold primary-text">جال للتجارة</span>
        </div>
        <p id="footerDesc" class="text-gray-500 max-w-md mx-auto">شريكك الموثوق في توريد المعدات والمنتجات الصناعية</p>
    </div>
    <nav class="flex flex-wrap justify-center gap-6 mb-4">
        <a href="/productCatalog" class="link link-hover hover:text-primary text-gray-300"><i class="fas fa-box-open ml-1"></i> <span id="fnavProducts">المنتجات</span></a>
        <a href="/cart" class="link link-hover hover:text-primary relative text-gray-300"><i class="fas fa-shopping-cart ml-1"></i> <span id="fnavCart">السلة</span><span x-show="cartCount > 0" x-cloak class="cart-badge" x-text="cartCount"></span></a>
        <a href="/contact" class="link link-hover hover:text-primary text-gray-300"><i class="fas fa-phone-alt ml-1"></i> <span id="fnavContact">تواصل معنا</span></a>
    </nav>
    <p id="copyrightText" class="text-gray-500 mt-4">© 2025 جال للتجارة والتوريدات — جميع الحقوق محفوظة</p>
</footer>

<script>
    const langs = {
        ar: {
            brandName: "جال لتوريدات المصانع",
            pageTitle: "طلب عرض سعر - جال للتجارة",
            mainTitle: "طلب عرض سعر",
            mainDesc: "اختر المنتجات التي تحتاجها وسنرسل لك عرض سعر مفصل",
            selectedLabel: "تم اختيار",
            productLabel: "منتج",
            clearBtn: "مسح الكل",
            filterTitle: "تصفية حسب التصنيف",
            allCat: "جميع التصنيفات",
            selectedBadge: "محدد",
            noProductsTitle: "لا توجد منتجات",
            noProductsDesc: "جرب اختيار تصنيف آخر أو تعديل البحث",
            submitBtn: "إرسال الطلب",
            dialogTitle: "إرسال الطلب عبر واتساب",
            nameLabel: "الاسم",
            nameInput: "اسمك الكامل",
            phoneLabel: "رقم الهاتف",
            phoneInput: "01xxxxxxxxx",
            notesLabel: "ملاحظات إضافية (اختياري)",
            notesInput: "أي تفاصيل إضافية...",
            selectedItemsTitle: "المنتجات المحددة",
            sendWhatsAppBtn: "إرسال عبر واتساب",
            cancelBtn: "إلغاء",
            navProducts: "المنتجات",
            navCart: "السلة",
            navContact: "تواصل معنا",
            mnavProducts: "المنتجات",
            mnavCart: "السلة",
            mnavContact: "تواصل معنا",
            fnavProducts: "المنتجات",
            fnavCart: "السلة",
            fnavContact: "تواصل معنا",
            footerBrand: "جال للتجارة",
            footerDesc: "شريكك الموثوق في توريد المعدات والمنتجات الصناعية",
            copyrightText: "© 2025 جال للتجارة والتوريدات — جميع الحقوق محفوظة",
            searchLabel: "بحث عن المنتجات",
            searchInput: "ابحث باسم المنتج أو الوصف...",
            showingLabel: "عرض",
            ofLabel: "من",
            pageLabel: "صفحة",
            ofPagesLabel: "من"
        },
        en: {
            brandName: "Gal Industrial Supplies",
            pageTitle: "Price Request - Gal Trading",
            mainTitle: "Request a Quote",
            mainDesc: "Select the products you need and we'll send you a detailed quote",
            selectedLabel: "Selected",
            productLabel: "product(s)",
            clearBtn: "Clear All",
            filterTitle: "Filter by Category",
            allCat: "All Categories",
            selectedBadge: "Selected",
            noProductsTitle: "No Products Found",
            noProductsDesc: "Try selecting another category or modifying your search",
            submitBtn: "Submit Request",
            dialogTitle: "Send Request via WhatsApp",
            nameLabel: "Name",
            nameInput: "Your full name",
            phoneLabel: "Phone Number",
            phoneInput: "01xxxxxxxxx",
            notesLabel: "Additional Notes (Optional)",
            notesInput: "Any additional details...",
            selectedItemsTitle: "Selected Products",
            sendWhatsAppBtn: "Send via WhatsApp",
            cancelBtn: "Cancel",
            navProducts: "Products",
            navCart: "Cart",
            navContact: "Contact",
            mnavProducts: "Products",
            mnavCart: "Cart",
            mnavContact: "Contact",
            fnavProducts: "Products",
            fnavCart: "Cart",
            fnavContact: "Contact",
            footerBrand: "Gal Trading",
            footerDesc: "Your trusted partner in industrial supplies",
            copyrightText: "© 2025 Gal Trading & Supplies — All rights reserved",
            searchLabel: "Search Products",
            searchInput: "Search by product name or description...",
            showingLabel: "Showing",
            ofLabel: "of",
            pageLabel: "Page",
            ofPagesLabel: "of"
        }
    };

    function applyTranslations(lang) {
        const t = langs[lang] || langs.ar;
        const map = {
            brandName: t.brandName,
            pageTitle: t.pageTitle,
            mainTitle: t.mainTitle,
            mainDesc: t.mainDesc,
            selectedLabel: t.selectedLabel,
            productLabel: t.productLabel,
            clearBtn: t.clearBtn,
            filterTitle: t.filterTitle,
            allCat: t.allCat,
            selectedBadge: t.selectedBadge,
            noProductsTitle: t.noProductsTitle,
            noProductsDesc: t.noProductsDesc,
            submitBtn: t.submitBtn,
            dialogTitle: t.dialogTitle,
            nameLabel: t.nameLabel,
            phoneLabel: t.phoneLabel,
            notesLabel: t.notesLabel,
            selectedItemsTitle: t.selectedItemsTitle,
            sendWhatsAppBtn: t.sendWhatsAppBtn,
            cancelBtn: t.cancelBtn,
            navProducts: t.navProducts,
            navCart: t.navCart,
            navContact: t.navContact,
            mnavProducts: t.mnavProducts,
            mnavCart: t.mnavCart,
            mnavContact: t.mnavContact,
            fnavProducts: t.fnavProducts,
            fnavCart: t.fnavCart,
            fnavContact: t.fnavContact,
            footerBrand: t.footerBrand,
            footerDesc: t.footerDesc,
            copyrightText: t.copyrightText,
            searchLabel: t.searchLabel,
            searchInput: t.searchInput,
            showingLabel: t.showingLabel,
            ofLabel: t.ofLabel,
            pageLabel: t.pageLabel,
            ofPagesLabel: t.ofPagesLabel
        };

        for (const id in map) {
            const el = document.getElementById(id);
            if (el && map[id]) el.innerText = map[id];
        }

        const nameInput = document.getElementById('nameInput');
        const phoneInput = document.getElementById('phoneInput');
        const notesInput = document.getElementById('notesInput');
        const searchInput = document.getElementById('searchInput');
        if (nameInput) nameInput.placeholder = t.nameInput;
        if (phoneInput) phoneInput.placeholder = t.phoneInput;
        if (notesInput) notesInput.placeholder = t.notesInput;
        if (searchInput) searchInput.placeholder = t.searchInput;

        document.title = t.pageTitle;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
        document.getElementById("current-lang").innerText = lang.toUpperCase();
        localStorage.setItem("lang", lang);
    }

    function changeLang(lang) {
        applyTranslations(lang);
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem("lang") || "ar";
        applyTranslations(saved);
    });

    function headerManager() {
        return {
            cartCount: 0,
            init() {
                this.loadCartCount();
                window.addEventListener('storage', () => this.loadCartCount());
                window.addEventListener('cartUpdated', () => this.loadCartCount());
            },
            loadCartCount() {
                const cart = localStorage.getItem('cart');
                const items = cart ? JSON.parse(cart) : [];
                this.cartCount = items.reduce((sum, item) => sum + item.quantity, 0);
            }
        };
    }

    function priceRequestApp() {
        return {
            products: [],
            categories: [],
            filteredProducts: [],
            selectedProducts: [],
            selectedCategory: '',
            searchQuery: '',
            loading: true,
            error: '',
            showDialog: false,
            customerName: '',
            customerPhone: '',
            countryCode: '+20',
            customerNotes: '',
            lang: localStorage.getItem('lang') || 'ar',
            pagination: {
                page: 1,
                limit: 12, // Default limit
                total: 0,
                totalPages: 0
            },

            get visiblePages() {
                const current = this.pagination.page;
                const total = this.pagination.totalPages;
                const pages = [];

                let start = Math.max(1, current - 2);
                let end = Math.min(total, current + 2);

                if (end - start < 4) {
                    if (start === 1) {
                        end = Math.min(total, start + 4);
                    } else if (end === total) {
                        start = Math.max(1, end - 4);
                    }
                }

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return pages;
            },

            async init() {
                const lang = localStorage.getItem('lang') || 'ar';
                this.lang = lang;
                if (typeof applyTranslations === 'function') applyTranslations(lang);
                await this.loadCategories();
                await this.loadProducts();
            },

            async loadProducts() {
                try {
                    this.loading = true;
                    this.error = '';
                    const cleanSearchQuery = this.cleanSearchText(this.searchQuery);

                    const params = new URLSearchParams({
                        page: this.pagination.page,
                        limit: this.pagination.limit, // Use the dynamic limit
                        search: cleanSearchQuery
                    });

                    if (this.selectedCategory) {
                        params.append('category', this.selectedCategory);
                    }

                    console.log('Search params:', params.toString());

                    const response = await fetch(`/api/products?${params}`);
                    if (!response.ok) throw new Error('Failed to load products');
                    const data = await response.json();

                    if (data.data) {
                        this.products = data.data;
                        this.pagination.total = data.total;
                        this.pagination.totalPages = data.totalPages;
                        this.pagination.page = data.page;
                    } else {
                        this.products = data;
                        this.pagination.total = data.length;
                        this.pagination.totalPages = Math.ceil(data.length / this.pagination.limit);
                    }

                    this.filteredProducts = this.products;
                } catch (err) {
                    this.error = (this.lang === 'en' ? 'Failed to load products' : 'حدث خطأ في تحميل المنتجات');
                    console.error('Error loading products:', err);
                } finally {
                    this.loading = false;
                }
            },

            cleanSearchText(text) {
                if (!text) return '';

                return text
                    .replace(/[^\w\u0600-\u06FF\s\d]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            },

            async loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    if (!response.ok) throw new Error('Failed to load categories');
                    this.categories = await response.json();
                } catch (err) {
                    console.error('Error loading categories:', err);
                }
            },

            async filterProducts() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            toggleProduct(product) {
                const index = this.selectedProducts.findIndex(p => p._id === product._id);
                if (index > -1) {
                    this.selectedProducts.splice(index, 1);
                } else {
                    this.selectedProducts.push(product);
                }
            },

            isSelected(productId) {
                return this.selectedProducts.some(p => p._id === productId);
            },

            clearSelection() {
                this.selectedProducts = [];
            },

            getCategoryName(categoryId) {
                const cat = this.categories.find(c => c._id === categoryId);
                return cat ? (this.lang === 'ar' ? cat.nameAr : cat.nameEn || cat.nameAr) : (this.lang === 'en' ? 'Unspecified' : 'غير محدد');
            },

            getCategoryCount(categoryId) {
                return this.products.filter(p => p.categoryId === categoryId).length;
            },

            async goToPage(page) {
                if (page < 1 || page > this.pagination.totalPages) return;
                this.pagination.page = page;
                await this.loadProducts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            async changeLimit() {
                this.pagination.page = 1;
                await this.loadProducts();
            },

            openWhatsAppDialog() {
                this.showDialog = true;
            },

            sendToWhatsApp() {
                if (!this.customerName || !this.customerPhone) {
                    const lang = this.lang;
                    alert(lang === 'en' ? 'Please fill in name and phone number' : 'يرجى ملء الاسم ورقم الهاتف');
                    return;
                }

                // Build WhatsApp message
                let message = this.lang === 'en'
                    ? `*Price Request*\n\n*Customer Name:* ${this.customerName}\n*Phone:* ${this.countryCode}${this.customerPhone}\n\n*Selected Products:*\n\n`
                    : `*طلب عرض سعر*\n\n*اسم العميل:* ${this.customerName}\n*الهاتف:* ${this.countryCode}${this.customerPhone}\n\n*المنتجات المطلوبة:*\n\n`;

                this.selectedProducts.forEach((product, index) => {
                    const name = this.lang === 'ar' ? product.nameAr : product.nameEn || product.nameAr;
                    const description = this.lang === 'ar' ? product.descriptionAr : product.descriptionEn || product.descriptionAr;
                    message += `${index + 1}. ${name}\n`;
                    message += `   ${this.lang === 'en' ? 'Category' : 'التصنيف'}: ${this.getCategoryName(product.categoryId)}\n`;
                    if (description) {
                        message += `   ${this.lang === 'en' ? 'Details' : 'الوصف'}: ${description}\n`;
                    }
                    message += `\n`;
                });

                if (this.customerNotes) {
                    message += this.lang === 'en'
                        ? `\n*Additional Notes:*\n${this.customerNotes}`
                        : `\n*ملاحظات إضافية:*\n${this.customerNotes}`;
                }

                // Company WhatsApp number
                const whatsappNumber = '+201002491168';
                const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

                window.open(url, '_blank');

                // Reset form
                this.showDialog = false;
                this.customerName = '';
                this.customerPhone = '';
                this.countryCode = '+20';
                this.customerNotes = '';
                this.selectedProducts = [];
            }
        };
    }
</script>
</body>
</html>